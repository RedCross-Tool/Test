<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Health Assessment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f9;
            color: #333;
        }
        header {
            text-align: center;
            padding: 20px;
            background: #ED1B2E;
            color: white;
            position: relative;
        }
        .logo {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }
        .box {
            flex: 1 1 calc(33.33% - 20px);
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            text-align: center;
            display: flex;
            flex-direction: column;
        }
        .box img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .box h3 {
            background: #ED1B2E;
            color: white;
            margin: 0;
            padding: 10px;
        }
        .box .content {
            padding: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .box .actions {
            display: flex;
            justify-content: space-around;
            padding: 10px;
        }
        .box button {
            background: #ED1B2E;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .box button:hover {
            background: #C41522;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            text-align: left;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h4 {
            margin-top: 0;
        }
        .modal-content p, .modal-content ul {
            margin: 10px 0;
        }
        .modal-content ul {
            padding-left: 20px;
            list-style: disc;
        }
        .modal-content button {
            display: block;
            margin: 20px auto 0;
            padding: 10px 15px;
            background: #ED1B2E;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .export-form {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .export-form button {
            background: #ED1B2E;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }
        .export-form button:hover {
            background: #C41522;
        }
        .question-item {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid #ED1B2E;
            background: #f9f9f9;
        }
        .questions-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .editable-question {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .editable-question textarea {
            width: 100%;
            min-height: 60px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        .editable-question .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .editable-question button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .editable-question .save-btn {
            background: #4CAF50;
            color: white;
        }
        .editable-question .delete-btn {
            background: #f44336;
            color: white;
        }
        .assessment-info {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 20px auto;
            max-width: 1200px;
        }
        footer {
            text-align: center;
            padding: 10px;
            background: #ED1B2E;
            color: white;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Climate Health Assessment</h1>
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRvju8KVWOA26EEHzvXjwEG4OIWNBauaBmvK11oEeaaf8u8j35cUzQplyGPt4Iy22J_Uqk&usqp=CAU" alt="Logo" class="logo">
    </header>

    <div class="assessment-info">
        <h2>Your Assessment Details</h2>
        <div id="assessmentDetails">
            <p>Loading assessment details...</p>
        </div>
    </div>
    <div class="container">
        <div class="box">
            <img src="https://cdn.redcross.ca/prodmedia/crc/azure/volunteer/emergency-responder-cta-thumbnail.jpg?ext=.jpg" alt="Survey">
            <h3>Survey</h3>
            <div class="content">
                <p>This survey, developed by CRC, collects information on the intersection between climate and health, residents' experiences with extreme weather events, and climate-related vulnerabilities.</p>
                <div class="actions">
                    <button onclick="showModal('surveyMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('survey')">Review Questions</button>
                </div>
            </div>
        </div>

        <div class="box">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZqsyqbp7oJDrumNi_aFGhCx_XkTiTPK_ZHw&s" alt="Key Informant Interview">
            <h3>Key Informant Interviews</h3>
            <div class="content">
                <p>This component gathers expert insights on the impact of climate change on health from various stakeholders and organizations.</p>
                <div class="actions">
                    <button onclick="showModal('kiiMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('kii')">Review Questions</button>
                </div>
            </div>
        </div>

        <div class="box">
            <img src="https://cdn.redcross.ca/prodmedia/crc/img/How-We-Help/Emergencies-and-Disasters-in-Canada/Les-benevoles.jpg" alt="Focus Group Discussion">
            <h3>Focus Group Discussion</h3>
            <div class="content">
                <p>This tool collects diverse views on the effects of climate change on health through structured group discussions.</p>
                <div class="actions">
                    <button onclick="showModal('fgdMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('fgd')">Review Questions</button>
                </div>
            </div>
        </div>

        <div class="box">
            <img src="https://cdn.redcross.ca/prodmedia/crc/img/recruitment.jpg" alt="Health Facilities Vulnerability Assessment">
            <h3>Health Facilities Vulnerability Assessment</h3>
            <div class="content">
                <p>This component assesses the vulnerability of health facilities to climate hazards using WHO-identified criteria.</p>
                <div class="actions">
                    <button onclick="showModal('hfvaMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('hfva')">Review Questions</button>
                </div>
            </div>
        </div>

        <div class="box">
            <img src="https://cdn.redcross.ca/prodmedia/crc/imgfr/Dans-votre-collectivite/Quebec/Website-Flood-2023-QC.jpg" alt="Climate Trends">
            <h3>Climate Trends</h3>
            <div class="content">
                <p>This section outlines key areas to be monitored during data collection to measure and analyze the impacts of climate change.</p>
                <div class="actions">
                    <button onclick="showModal('climateTrendsMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('climateTrends')">Review Questions</button>
                </div>
            </div>
        </div>

        <div class="box">
            <img src="https://cdn.redcross.ca/prodmedia/crc/img/Volunteer/220118VR-VR-Portal-Emergency-Thumbnails-Emergency-Supervisor.jpg?ext=.jpg" alt="Disease per Climate Hazards">
            <h3>Disease per Climate Hazards</h3>
            <div class="content">
                <p>This table categorizes various climate hazards and their associated disease categories, outlining specific indicators to monitor.</p>
                <div class="actions">
                    <button onclick="showModal('diseaseHazardsMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('diseaseHazards')">Review Questions</button>
                </div>
            </div>
        </div>
    </div>
    <div id="surveyMethodology" class="modal">
        <div class="modal-content">
            <h4>Survey Methodology</h4>
            <p>Study Design: Community-based, cross-sectional survey.</p>
            <p>Study Setting: First, choose a district from a certain country, and then focus on a particular region in the selected district.</p>
            <p>Sample Size: Determine the target population within the chosen area and calculate the sample size using probability proportional to size (PPS) sampling based on the population and the desired level of precision. The formula for calculating the sample size for your survey so that the results are statistically significant is: n=N/(1+N(e^2))</p>
            <p>where:</p>
            <ul>
                <li>n is the sample size</li>
                <li>N is the population size</li>
                <li>e is the level of precision (often called the margin of error)</li>
            </ul>
            <p>Sampling Technique: Multi-stage random sampling to select participating wards and households.</p>
            <p>Recruitment: A standard questionnaire is distributed to either the head of the household or to adult residents to collect information on family characteristics, climate change perceptions, and adaptation strategies.</p>
            <p>Data Analysis: The recommended Data collection tool to be used is the Microsoft forms or KOBO tool, which will be entered into a statistical package or Microsoft Excel and then presented in tables, graphs, and charts.</p>
            <button onclick="closeModal('surveyMethodology')">Close</button>
        </div>
    </div>

    <div id="kiiMethodology" class="modal">
        <div class="modal-content">
            <h4>Key Informant Interview Methodology</h4>
            <p>1. Description:</p>
            <ul>
                <li>Conduct X interviews with participants from government/ Community and other organizations to find out the capacity of the health system in addressing climate change.</li>
                <li>Interviews should be between 45-60 minutes in length.</li>
                <li>Consent to be recorded from participants during interview.</li>
            </ul>
            <p>2. Recruitment:</p>
            <ul>
                <li>Purposive sampling based on secondary data collection.</li>
                <li>Recruitment of stakeholders involved in climate change, including:</li>
                <ul>
                    <li>Local government/ Community leaders</li>
                    <li>Key informants (project officers or managers) in NGOs and INGOs</li>
                    <li>Local health authorities</li>
                    <li>Climate change advocates and academics</li>
                </ul>
            </ul>
            <p>3. Data Collection:</p>
            <ul>
                <li>Semi-structured interviews to allow in-depth discussions.</li>
                <li>Translator assistance for interviews when needed.</li>
            </ul>
            <p>4. Data Analysis:</p>
            <ul>
                <li>The interviews to be done with consent and are to be recorded and then transcribed.</li>
                <li>The data will be coded and grouped into themes and sub-themes.</li>
                <li>Internal triangulation to ensure trustworthiness, through collective discussion and refinement of themes by the project team.</li>
            </ul>
            <button onclick="closeModal('kiiMethodology')">Close</button>
        </div>
    </div>

    <div id="fgdMethodology" class="modal">
        <div class="modal-content">
            <h4>Focus Group Discussion Methodology</h4>
            <p>Purpose:</p>
            <ul>
                <li>To gather community insights on climate change threats, vulnerabilities, and response capacities.</li>
                <li>To understand how climate change impacts health and identify areas for improvement.</li>
            </ul>
            <p>Procedure:</p>
            <ul>
                <li>The group interviews should be conducted for 90 minutes, and each group should have 6-10 participants.</li>
                <li>A facilitator to lead the discussion and note takes place to write down ideas provided by participants.</li>
                <li>The discussions will be audio recorded only if the participants agree to allow the researcher to capture all the information in full. The recordings will remain inaccessible to anyone outside the research team.</li>
                <li>It is entirely voluntary to participate, and anyone can leave the study at any time without any consequences.</li>
            </ul>
            <p>Confidentiality:</p>
            <ul>
                <li>Participants' privacy to be observed and all information collected should be used only for the purpose of this study and should be treated with confidentiality.</li>
                <li>Data should be analyzed anonymously, and no participant will be identified in the results of the study.</li>
                <li>The study records including consent forms to be kept in a safe place and can only be accessed by the designated authorized staff.</li>
            </ul>
            <p>Recruitment:</p>
            <ul>
                <li>Purposive/convenience sampling will be used to select participants according to their interest and knowledge of climate change.</li>
                <li>A screening interview will also be done to establish the eligibility of the participants.</li>
                <li>The participants should be above X years and should be involved in community health efforts but not in public health or medical professional employment.</li>
                <li>Attempts will be made to incorporate participants with different levels of climate change awareness.</li>
            </ul>
            <p>Data Collection:</p>
            <ul>
                <li>Topics include community health, climate change impacts, knowledge gaps and future strategies in relation to climate change and health.</li>
                <li>In addition, non-verbal responses will also be collected during the discussion to include all the possible participant inputs.</li>
            </ul>
            <p>Data Analysis:</p>
            <ul>
                <li>The discussions will be recorded and where possible transcribed and translated.</li>
                <li>To identify key themes and sub-themes, a thematic analysis will be conducted.</li>
                <li>Triangulation will be internal, where several team members analyze the data independently and then collectively refine the themes for trustworthiness and consistency.</li>
            </ul>
            <button onclick="closeModal('fgdMethodology')">Close</button>
        </div>
    </div>
    
    <div id="hfvaMethodology" class="modal">
        <div class="modal-content">
            <h4>Health Facilities Vulnerability Assessment Methodology</h4>
            <p>This component represents a full-fledged checklist of vulnerability of health facilities as identified by the World Health Organization (WHO). It classifies different climate hazards and their corresponding health impacts then lists the criteria and questions to determine the readiness and robustness of health facilities. This checklist when used by researchers and analysts will help in a more systematic collection of data, and determination of risks and effects of various climate hazards. This is a more systematic way of approaching the vulnerabilities in health facilities and thus leads to better risk management and adaptation decisions.</p>
            <button onclick="closeModal('hfvaMethodology')">Close</button>
        </div>
    </div>

    <div id="climateTrendsMethodology" class="modal">
        <div class="modal-content">
            <h4>Climate Trends Methodology</h4>
            <p>In order to properly measure and analyse the impacts of climate change the following key areas will be monitored during the data collection process.</p>
            <p>This table provides a systematic approach for identifying the types of data required for analysing trends in climate hazards and their explanations. It helps in identifying the data that needs to be tracked and evaluated for every climate hazard of concern. Using this table, researchers and analysts can consistently obtain the right data to make evaluations of the effects and trends of the various climate hazards. This is a more systematic way of approaching the analysis of the hazards with the aim of having a better understanding of the hazards and their risks and thus being in a better position to mitigate the risks in question in the best way possible as far as climate risk management and adaptation are concerned.</p>
            <button onclick="closeModal('climateTrendsMethodology')">Close</button>
        </div>
    </div>

    <div id="diseaseHazardsMethodology" class="modal">
        <div class="modal-content">
            <h4>Disease per Climate Hazards Methodology</h4>
            <p>This table is a robust toolkit for climate hazard analysis, categorizing various climate hazards and their associated disease categories. It outlines the specific indicators to monitor for each disease category, to help researchers and analysts gather the right data in a systematic way. This table is useful for identifying and assessing the impacts and trends related to different climate hazards, and this structured approach helps us better understand the health implications of climate hazards and better inform risk management and adaptation strategies.</p>
            <button onclick="closeModal('diseaseHazardsMethodology')">Close</button>
        </div>
    </div>
    <!-- Questions Modal for all sections -->
    <div id="questionsModal" class="modal">
        <div class="modal-content">
            <h4 id="questionsModalTitle">Section Questions</h4>
            <div id="questionsContainer" class="questions-container">
                <p>Loading questions...</p>
            </div>
            <div id="editQuestionsContainer"></div>
            <div style="display: flex; justify-content: space-between;">
                <button onclick="closeModal('questionsModal')">Close</button>
                <button id="saveAllQuestionsBtn" style="background-color: #4CAF50;">Save All Changes</button>
            </div>
        </div>
    </div>

    <div class="export-form">
        <button onclick="exportAssessment()">Export Assessment</button>
    </div>

    <footer>
        &copy; 2025 Global Health in Emergency Research Team
    </footer>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <script>
        // Initialize Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDurfWVGVnIIfbc0plLD5sPp-VPyv8j3SQ",
    authDomain: "canadian-red-cross-cc-app.firebaseapp.com",
    projectId: "canadian-red-cross-cc-app",
    storageBucket: "canadian-red-cross-cc-app.firebasestorage.app",
    messagingSenderId: "142442090355",
    appId: "1:142442090355:web:447b25a0487d8ba9f83f06",
    measurementId: "G-1C3RCZX1NV"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Global variables
let currentSubmissionId = null;
let currentSubmissionData = null;
let currentSectionQuestions = {};
let currentSection = null;

// Collection mapping for each section
const sectionCollections = {
    'survey': 'Survey_',
    'kii': 'KII',
    'fgd': 'FGD',
    'hfva': 'WHO_Hazards_Checklis',
    'climateTrends': 'Meteorological_indicators',
    'diseaseHazards': 'Disease_indicators'
};

// Modal functions
function showModal(id) {
    document.getElementById(id).style.display = 'flex';
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

// Function to show questions modal for a specific section
function showQuestionsModal(section) {
    currentSection = section;
    document.getElementById('questionsModalTitle').textContent = getSectionTitle(section) + ' Questions';
    document.getElementById('questionsContainer').innerHTML = '<p>Loading questions...</p>';
    document.getElementById('editQuestionsContainer').innerHTML = '';
    showModal('questionsModal');
    
    if (currentSubmissionId) {
        loadQuestionsForSection(section, currentSubmissionId);
    } else {
        document.getElementById('questionsContainer').innerHTML = 
            '<p>No submission data found. Please go back to the input form and submit your selections.</p>';
    }
}

// Function to get section title
function getSectionTitle(section) {
    const titles = {
        'survey': 'Survey',
        'kii': 'Key Informant Interviews',
        'fgd': 'Focus Group Discussion',
        'hfva': 'Health Facilities Vulnerability Assessment',
        'climateTrends': 'Climate Trends',
        'diseaseHazards': 'Disease per Climate Hazards'
    };
    return titles[section] || 'Section';
}

// Function to load assessment details based on submission ID
async function loadAssessmentDetails(submissionId) {
    try {
        console.log("Fetching submission document:", submissionId);
        const submissionDoc = await db.collection('submissions').doc(submissionId).get();
        
        console.log("Document exists:", submissionDoc.exists);
        
        if (!submissionDoc.exists) {
            document.getElementById('assessmentDetails').innerHTML = 
                '<p>Submission not found. Please go back to the input form and submit your selections.</p>';
            return;
        }
        
        currentSubmissionData = submissionDoc.data();
        console.log("Submission data:", currentSubmissionData);
        
        // Display assessment details
        const details = document.getElementById('assessmentDetails');
        details.innerHTML = `
            <p><strong>Date:</strong> ${new Date(currentSubmissionData.timestamp).toLocaleDateString()}</p>
            <p><strong>Climate Hazards:</strong> ${formatArrayForDisplay(currentSubmissionData.climateHazards)}</p>
            <p><strong>Diseases:</strong> ${formatArrayForDisplay(currentSubmissionData.diseases)}</p>
            <p><strong>Regions:</strong> ${formatArrayForDisplay(currentSubmissionData.regions)}</p>
            <p><strong>Domestic (Canada):</strong> ${formatArrayForDisplay(currentSubmissionData.domestic)}</p>
        `;
    } catch (error) {
        console.error('Error loading assessment details:', error);
        document.getElementById('assessmentDetails').innerHTML = 
            `<p>Error loading assessment details: ${error.message}</p>`;
    }
}


// Function to format array for display
function formatArrayForDisplay(arr) {
    if (!arr || arr.length === 0) return 'None';
    
    return arr.map(item => {
        // Convert snake_case to Title Case
        return item.split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }).join(', ');
}

// Function to load questions for a specific section based on submission
async function loadQuestionsForSection(section, submissionId) {
    try {
        // Get the submission data if not already loaded
        if (!currentSubmissionData) {
            const submissionDoc = await db.collection('submissions').doc(submissionId).get();
            if (!submissionDoc.exists) {
                document.getElementById('questionsContainer').innerHTML = 
                    '<p>Submission not found. Please go back to the input form and submit your selections.</p>';
                return;
            }
            currentSubmissionData = submissionDoc.data();
        }
        
        const climateHazards = currentSubmissionData.climateHazards || [];
        const diseases = currentSubmissionData.diseases || [];
        
        // If no hazards or diseases, show message
        if (climateHazards.length === 0 || diseases.length === 0) {
            document.getElementById('questionsContainer').innerHTML = 
                '<p>No climate hazards or diseases selected. Please go back to the input form and make selections.</p>';
            return;
        }
        
        // Get the collection for this section
        const collectionName = sectionCollections[section] || 'Survey_';
        
        // Query for matching questions in the specific section
        let questionsSnapshot;
        
        // Different query strategies based on section
        switch(section) {
            case 'climateTrends':
                // For Meteorological_indicators, query by climate hazards
                questionsSnapshot = await db.collection(collectionName)
                    .where('climateHazards', '==', climateHazards[0])
                    .get();
                break;
                
            case 'diseaseHazards':
                // For Disease_indicators, query by climate hazards and disease category
                questionsSnapshot = await db.collection(collectionName)
                    .where('climateHazards', '==', climateHazards[0])
                    .where('diseaseCategory', '==', diseases[0])
                    .get();
                break;
                
            case 'survey':
            case 'kii':
            case 'fgd':
            case 'hfva':
                // For other collections, try to match by climateHazards array field
                questionsSnapshot = await db.collection(collectionName)
                    .where('climateHazards', 'array-contains-any', climateHazards)
                    .get();
                    
                // If no results, try by climateHazards string field
                if (questionsSnapshot.empty) {
                    questionsSnapshot = await db.collection(collectionName)
                        .where('climateHazards', '==', climateHazards[0])
                        .get();
                }
                
                // If still no results, try to get all documents
                if (questionsSnapshot.empty) {
                    questionsSnapshot = await db.collection(collectionName)
                        .limit(10)
                        .get();
                }
                break;
                
            default:
                // Default query
                questionsSnapshot = await db.collection(collectionName)
                    .limit(10)
                    .get();
        }
        
        // Process results
        let questions = [];
        
        questionsSnapshot.forEach(doc => {
            questions.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        // Store questions for this section
        currentSectionQuestions[section] = questions;
        
        // Display questions
        displayQuestions(questions, section);
        
    } catch (error) {
        console.error('Error loading questions:', error);
        document.getElementById('questionsContainer').innerHTML = 
            `<p>Error loading questions: ${error.message}</p>`;
    }
}

// Function to display questions
function displayQuestions(questions, section) {
    const container = document.getElementById('questionsContainer');
    const editContainer = document.getElementById('editQuestionsContainer');
    
    if (questions.length === 0) {
        container.innerHTML = '<p>No matching questions found for this section.</p>';
        editContainer.innerHTML = '';
        return;
    }
    
    // Display questions based on section type
    switch(section) {
        case 'climateTrends':
            displayClimateQuestionsTable(questions, container);
            break;
            
        case 'diseaseHazards':
            displayDiseaseIndicatorsTable(questions, container);
            break;
            
        case 'kii':
        case 'fgd':
            displayInterviewQuestions(questions, container, section);
            break;
            
        case 'hfva':
            displayChecklistQuestions(questions, container);
            break;
            
        case 'survey':
        default:
            displaySurveyQuestions(questions, container);
    }
    
    // Create editable questions section
    createEditableQuestions(questions, editContainer, section);
}

// Function to display Climate Trends questions as a table
function displayClimateQuestionsTable(questions, container) {
    container.innerHTML = '<h4>Meteorological Data to Collect:</h4>';
    
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '10px';
    
    // Create table header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    const hazardHeader = document.createElement('th');
    hazardHeader.textContent = 'Climate Hazard';
    hazardHeader.style.padding = '8px';
    hazardHeader.style.backgroundColor = '#f2f2f2';
    hazardHeader.style.border = '1px solid #ddd';
    hazardHeader.style.textAlign = 'left';
    
    const typeHeader = document.createElement('th');
    typeHeader.textContent = 'Type of Data to be Collected';
    typeHeader.style.padding = '8px';
    typeHeader.style.backgroundColor = '#f2f2f2';
    typeHeader.style.border = '1px solid #ddd';
    typeHeader.style.textAlign = 'left';
    
    const descHeader = document.createElement('th');
    descHeader.textContent = 'Description';
    descHeader.style.padding = '8px';
    descHeader.style.backgroundColor = '#f2f2f2';
    descHeader.style.border = '1px solid #ddd';
    descHeader.style.textAlign = 'left';
    
    headerRow.appendChild(hazardHeader);
    headerRow.appendChild(typeHeader);
    headerRow.appendChild(descHeader);
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create table body
    const tbody = document.createElement('tbody');
    
    questions.forEach((item, index) => {
        const row = document.createElement('tr');
        
        const hazardCell = document.createElement('td');
        hazardCell.textContent = formatValue(item.climateHazards || '');
        hazardCell.style.padding = '8px';
        hazardCell.style.border = '1px solid #ddd';
        
        const typeCell = document.createElement('td');
        typeCell.textContent = item.typeOfData || item.question || '';
        typeCell.style.padding = '8px';
        typeCell.style.border = '1px solid #ddd';
        
        const descCell = document.createElement('td');
        descCell.textContent = item.description || '';
        descCell.style.padding = '8px';
        descCell.style.border = '1px solid #ddd';
        
        row.appendChild(hazardCell);
        row.appendChild(typeCell);
        row.appendChild(descCell);
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    container.appendChild(table);
}

// Function to display Disease Indicators as a table
function displayDiseaseIndicatorsTable(questions, container) {
    container.innerHTML = '<h4>Disease Indicators to Monitor:</h4>';
    
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '10px';
    
    // Create table header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    const hazardHeader = document.createElement('th');
    hazardHeader.textContent = 'Climate Hazard';
    hazardHeader.style.padding = '8px';
    hazardHeader.style.backgroundColor = '#f2f2f2';
    hazardHeader.style.border = '1px solid #ddd';
    hazardHeader.style.textAlign = 'left';
    
    const diseaseHeader = document.createElement('th');
    diseaseHeader.textContent = 'Disease Category';
    diseaseHeader.style.padding = '8px';
    diseaseHeader.style.backgroundColor = '#f2f2f2';
    diseaseHeader.style.border = '1px solid #ddd';
    diseaseHeader.style.textAlign = 'left';
    
    const indicatorsHeader = document.createElement('th');
    indicatorsHeader.textContent = 'Indicators to Follow';
    indicatorsHeader.style.padding = '8px';
    indicatorsHeader.style.backgroundColor = '#f2f2f2';
    indicatorsHeader.style.border = '1px solid #ddd';
    indicatorsHeader.style.textAlign = 'left';
    
    headerRow.appendChild(hazardHeader);
    headerRow.appendChild(diseaseHeader);
    headerRow.appendChild(indicatorsHeader);
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create table body
    const tbody = document.createElement('tbody');
    
    questions.forEach((item, index) => {
        const row = document.createElement('tr');
        
        const hazardCell = document.createElement('td');
        hazardCell.textContent = item.climateHazards || '';
        hazardCell.style.padding = '8px';
        hazardCell.style.border = '1px solid #ddd';
        
        const diseaseCell = document.createElement('td');
        diseaseCell.textContent = item.diseaseCategory || '';
        diseaseCell.style.padding = '8px';
        diseaseCell.style.border = '1px solid #ddd';
        
        const indicatorsCell = document.createElement('td');
        indicatorsCell.textContent = item.indicatorsToFollow || '';
        indicatorsCell.style.padding = '8px';
        indicatorsCell.style.border = '1px solid #ddd';
        
        row.appendChild(hazardCell);
        row.appendChild(diseaseCell);
        row.appendChild(indicatorsCell);
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    container.appendChild(table);
}

// Function to display Interview Questions (KII and FGD)
function displayInterviewQuestions(questions, container, section) {
    const title = section === 'kii' ? 'Key Informant Interview Questions:' : 'Focus Group Discussion Questions:';
    container.innerHTML = `<h4>${title}</h4>`;
    
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '10px';
    
    // Create table header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    const hazardHeader = document.createElement('th');
    hazardHeader.textContent = 'Climate Hazard';
    hazardHeader.style.padding = '8px';
    hazardHeader.style.backgroundColor = '#f2f2f2';
    hazardHeader.style.border = '1px solid #ddd';
    hazardHeader.style.textAlign = 'left';
    
    const questionHeader = document.createElement('th');
    questionHeader.textContent = 'Question';
    questionHeader.style.padding = '8px';
    questionHeader.style.backgroundColor = '#f2f2f2';
    questionHeader.style.border = '1px solid #ddd';
    questionHeader.style.textAlign = 'left';
    
    const probesHeader = document.createElement('th');
    probesHeader.textContent = 'Potential Probes/Follow-ups';
    probesHeader.style.padding = '8px';
    probesHeader.style.backgroundColor = '#f2f2f2';
    probesHeader.style.border = '1px solid #ddd';
    probesHeader.style.textAlign = 'left';
    
    headerRow.appendChild(hazardHeader);
    headerRow.appendChild(questionHeader);
    
    if (section === 'fgd') {
        headerRow.appendChild(probesHeader);
    }
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create table body
    const tbody = document.createElement('tbody');
    
    questions.forEach((item, index) => {
        const row = document.createElement('tr');
        
        const hazardCell = document.createElement('td');
        hazardCell.textContent = item.climateHazards || '';
        hazardCell.style.padding = '8px';
        hazardCell.style.border = '1px solid #ddd';
        
        const questionCell = document.createElement('td');
        questionCell.textContent = item.question || '';
        questionCell.style.padding = '8px';
        questionCell.style.border = '1px solid #ddd';
        
        row.appendChild(hazardCell);
        row.appendChild(questionCell);
        
        if (section === 'fgd') {
            const probesCell = document.createElement('td');
            probesCell.textContent = item.potentialProbes || '';
            probesCell.style.padding = '8px';
            probesCell.style.border = '1px solid #ddd';
            row.appendChild(probesCell);
        }
        
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    container.appendChild(table);
}

// Function to display Checklist Questions (HFVA)
function displayChecklistQuestions(questions, container) {
    container.innerHTML = '<h4>Health Facilities Vulnerability Assessment Checklist:</h4>';
    
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '10px';
    
    // Create table header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    const hazardHeader = document.createElement('th');
    hazardHeader.textContent = 'Climate Hazard';
    hazardHeader.style.padding = '8px';
    hazardHeader.style.backgroundColor = '#f2f2f2';
    hazardHeader.style.border = '1px solid #ddd';
    hazardHeader.style.textAlign = 'left';
    
    const checklistHeader = document.createElement('th');
    checklistHeader.textContent = 'Checklist Item';
    checklistHeader.style.padding = '8px';
    checklistHeader.style.backgroundColor = '#f2f2f2';
    checklistHeader.style.border = '1px solid #ddd';
    checklistHeader.style.textAlign = 'left';
    
    headerRow.appendChild(hazardHeader);
    headerRow.appendChild(checklistHeader);
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create table body
    const tbody = document.createElement('tbody');
    
    questions.forEach((item, index) => {
        const row = document.createElement('tr');
        
        const hazardCell = document.createElement('td');
        hazardCell.textContent = item.climateHazards || '';
        hazardCell.style.padding = '8px';
        hazardCell.style.border = '1px solid #ddd';
        
        const checklistCell = document.createElement('td');
        checklistCell.textContent = item.question || item.checklistItem || '';
        checklistCell.style.padding = '8px';
        checklistCell.style.border = '1px solid #ddd';
        
        row.appendChild(hazardCell);
        row.appendChild(checklistCell);
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    container.appendChild(table);
}

// Function to display Survey Questions
function displaySurveyQuestions(questions, container) {
    container.innerHTML = '<h4>Survey Questions:</h4>';
    
    const questionsList = document.createElement('ol');
    questionsList.style.paddingLeft = '20px';
    
    questions.forEach((item, index) => {
        const listItem = document.createElement('li');
        listItem.textContent = item.question || '';
        listItem.style.marginBottom = '10px';
        questionsList.appendChild(listItem);
    });
    
    container.appendChild(questionsList);
}

// Function to create editable questions interface
function createEditableQuestions(questions, container, section) {
    container.innerHTML = '<h4>Edit Questions:</h4>';
    
    questions.forEach((item, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'editable-question';
        questionDiv.dataset.id = item.id;
        questionDiv.dataset.index = index;
        
        // Create appropriate fields based on section
        switch(section) {
            case 'climateTrends':
                createClimateEditFields(item, questionDiv, index);
                break;
                
            case 'diseaseHazards':
                createDiseaseEditFields(item, questionDiv, index);
                break;
                
            case 'fgd':
                createFGDEditFields(item, questionDiv, index);
                break;
                
            case 'kii':
            case 'hfva':
            case 'survey':
            default:
                createDefaultEditFields(item, questionDiv, index);
        }
        
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'buttons';
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'save-btn';
        saveBtn.textContent = 'Save';
        saveBtn.onclick = function() { saveQuestion(item.id, index, section); };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = function() { deleteQuestion(item.id, index, section); };
        
        buttonsDiv.appendChild(saveBtn);
        buttonsDiv.appendChild(deleteBtn);
        questionDiv.appendChild(buttonsDiv);
        
        container.appendChild(questionDiv);
    });
    
    // Add "Add New Question" button
    const addNewBtn = document.createElement('button');
    addNewBtn.textContent = 'Add New Question';
    addNewBtn.style.marginTop = '15px';
    addNewBtn.style.backgroundColor = '#4CAF50';
    addNewBtn.style.color = 'white';
    addNewBtn.style.border = 'none';
    addNewBtn.style.padding = '8px 16px';
    addNewBtn.style.borderRadius = '4px';
    addNewBtn.style.cursor = 'pointer';
    addNewBtn.onclick = function() { addNewQuestion(section); };
    
    container.appendChild(addNewBtn);
}

// Helper functions for creating edit fields
function createClimateEditFields(item, container, index) {
    const hazardInput = document.createElement('input');
    hazardInput.type = 'text';
    hazardInput.value = item.climateHazards || '';
    hazardInput.id = `hazard-${index}`;
    hazardInput.placeholder = 'Climate Hazard';
    hazardInput.style.width = '100%';
    hazardInput.style.marginBottom = '5px';
    hazardInput.style.padding = '8px';
    hazardInput.style.border = '1px solid #ccc';
    hazardInput.style.borderRadius = '4px';
    
    const typeInput = document.createElement('input');
    typeInput.type = 'text';
    typeInput.value = item.typeOfData || item.question || '';
    typeInput.id = `question-${index}`;
    typeInput.placeholder = 'Type of Data to be Collected';
    typeInput.style.width = '100%';
    typeInput.style.marginBottom = '5px';
    typeInput.style.padding = '8px';
    typeInput.style.border = '1px solid #ccc';
    typeInput.style.borderRadius = '4px';
    
    const descTextarea = document.createElement('textarea');
    descTextarea.value = item.description || '';
    descTextarea.id = `description-${index}`;
    descTextarea.placeholder = 'Description';
    descTextarea.style.width = '100%';
    descTextarea.style.minHeight = '60px';
    descTextarea.style.marginBottom = '10px';
    descTextarea.style.padding = '8px';
    descTextarea.style.border = '1px solid #ccc';
    descTextarea.style.borderRadius = '4px';
    descTextarea.style.resize = 'vertical';
    
    container.appendChild(hazardInput);
    container.appendChild(typeInput);
    container.appendChild(descTextarea);
}

function createDiseaseEditFields(item, container, index) {
    const hazardInput = document.createElement('input');
    hazardInput.type = 'text';
    hazardInput.value = item.climateHazards || '';
    hazardInput.id = `hazard-${index}`;
    hazardInput.placeholder = 'Climate Hazard';
    hazardInput.style.width = '100%';
    hazardInput.style.marginBottom = '5px';
    hazardInput.style.padding = '8px';
    hazardInput.style.border = '1px solid #ccc';
    hazardInput.style.borderRadius = '4px';
    
    const diseaseInput = document.createElement('input');
    diseaseInput.type = 'text';
    diseaseInput.value = item.diseaseCategory || '';
    diseaseInput.id = `disease-${index}`;
    diseaseInput.placeholder = 'Disease Category';
    diseaseInput.style.width = '100%';
    diseaseInput.style.marginBottom = '5px';
    diseaseInput.style.padding = '8px';
    diseaseInput.style.border = '1px solid #ccc';
    diseaseInput.style.borderRadius = '4px';
    
    const indicatorsTextarea = document.createElement('textarea');
    indicatorsTextarea.value = item.indicatorsToFollow || '';
    indicatorsTextarea.id = `indicators-${index}`;
    indicatorsTextarea.placeholder = 'Indicators to Follow';
    indicatorsTextarea.style.width = '100%';
    indicatorsTextarea.style.minHeight = '60px';
    indicatorsTextarea.style.marginBottom = '10px';
    indicatorsTextarea.style.padding = '8px';
    indicatorsTextarea.style.border = '1px solid #ccc';
    indicatorsTextarea.style.borderRadius = '4px';
    indicatorsTextarea.style.resize = 'vertical';
    
    container.appendChild(hazardInput);
    container.appendChild(diseaseInput);
    container.appendChild(indicatorsTextarea);
}

function createFGDEditFields(item, container, index) {
    const hazardInput = document.createElement('input');
    hazardInput.type = 'text';
    hazardInput.value = item.climateHazards || '';
    hazardInput.id = `hazard-${index}`;
    hazardInput.placeholder = 'Climate Hazard';
    hazardInput.style.width = '100%';
    hazardInput.style.marginBottom = '5px';
    hazardInput.style.padding = '8px';
    hazardInput.style.border = '1px solid #ccc';
    hazardInput.style.borderRadius = '4px';
    
    const questionInput = document.createElement('textarea');
    questionInput.value = item.question || '';
    questionInput.id = `question-${index}`;
    questionInput.placeholder = 'Question';
    questionInput.style.width = '100%';
    questionInput.style.minHeight = '60px';
    questionInput.style.marginBottom = '5px';
    questionInput.style.padding = '8px';
    questionInput.style.border = '1px solid #ccc';
    questionInput.style.borderRadius = '4px';
    questionInput.style.resize = 'vertical';
    
    const probesTextarea = document.createElement('textarea');
    probesTextarea.value = item.potentialProbes || '';
    probesTextarea.id = `probes-${index}`;
    probesTextarea.placeholder = 'Potential Probes/Follow-ups';
    probesTextarea.style.width = '100%';
    probesTextarea.style.minHeight = '60px';
    probesTextarea.style.marginBottom = '10px';
    probesTextarea.style.padding = '8px';
    probesTextarea.style.border = '1px solid #ccc';
    probesTextarea.style.borderRadius = '4px';
    probesTextarea.style.resize = 'vertical';
    
    container.appendChild(hazardInput);
    container.appendChild(questionInput);
    container.appendChild(probesTextarea);
}

function createDefaultEditFields(item, container, index) {
    const hazardInput = document.createElement('input');
    hazardInput.type = 'text';
    hazardInput.value = item.climateHazards || '';
    hazardInput.id = `hazard-${index}`;
    hazardInput.placeholder = 'Climate Hazard';
    hazardInput.style.width = '100%';
    hazardInput.style.marginBottom = '5px';
    hazardInput.style.padding = '8px';
    hazardInput.style.border = '1px solid #ccc';
    hazardInput.style.borderRadius = '4px';
    
    const questionTextarea = document.createElement('textarea');
    questionTextarea.value = item.question || '';
    questionTextarea.id = `question-${index}`;
    questionTextarea.placeholder = 'Question';
    questionTextarea.style.width = '100%';
    questionTextarea.style.minHeight = '60px';
    questionTextarea.style.marginBottom = '10px';
    questionTextarea.style.padding = '8px';
    questionTextarea.style.border = '1px solid #ccc';
    questionTextarea.style.borderRadius = '4px';
    questionTextarea.style.resize = 'vertical';
    
    container.appendChild(hazardInput);
    container.appendChild(questionTextarea);
}

// Function to save edited question
async function saveQuestion(id, index, section) {
try {
// Get the collection for this section
const collectionName = sectionCollections[section] || 'Survey_';

    // Create update data object based on section
    const updateData = {};
    
    switch(section) {
        case 'climateTrends':
            updateData.climateHazards = document.getElementById(`hazard-${index}`).value.trim();
            updateData.typeOfData = document.getElementById(`question-${index}`).value.trim();
            updateData.description = document.getElementById(`description-${index}`).value.trim();
            break;
            
        case 'diseaseHazards':
            updateData.climateHazards = document.getElementById(`hazard-${index}`).value.trim();
            updateData.diseaseCategory = document.getElementById(`disease-${index}`).value.trim();
            updateData.indicatorsToFollow = document.getElementById(`indicators-${index}`).value.trim();
            break;
            
        case 'fgd':
            updateData.climateHazards = document.getElementById(`hazard-${index}`).value.trim();
            updateData.question = document.getElementById(`question-${index}`).value.trim();
            updateData.potentialProbes = document.getElementById(`probes-${index}`).value.trim();
            break;
            
        case 'kii':
        case 'hfva':
        case 'survey':
        default:
            updateData.climateHazards = document.getElementById(`hazard-${index}`).value.trim();
            updateData.question = document.getElementById(`question-${index}`).value.trim();
    }
    
    // Validate required fields
    if (section === 'climateTrends' && (!updateData.typeOfData || !updateData.description)) {
        alert('Type of Data and Description are required');
        return;
    } else if (section === 'diseaseHazards' && (!updateData.diseaseCategory || !updateData.indicatorsToFollow)) {
        alert('Disease Category and Indicators are required');
        return;
    } else if ((section === 'kii' || section === 'fgd' || section === 'survey' || section === 'hfva') && !updateData.question) {
        alert('Question is required');
        return;
    }
    
    // Update the question in Firestore
    await db.collection(collectionName).doc(id).update(updateData);
    
    // Update local data
    const sectionQuestions = currentSectionQuestions[currentSection];
    if (sectionQuestions && sectionQuestions[index]) {
        Object.assign(sectionQuestions[index], updateData);
    }
    
    alert('Question updated successfully');
} catch (error) {
    console.error('Error saving question:', error);
    alert('Error saving question: ' + error.message);
}
}

// Function to delete question
async function deleteQuestion(id, index, section) {
if (!confirm('Are you sure you want to delete this question?')) {
return;
}

try {
    // Get the collection for this section
    const collectionName = sectionCollections[section] || 'Survey_';
    
    // Delete the question from Firestore
    await db.collection(collectionName).doc(id).delete();
    
    // Remove from local data
    const sectionQuestions = currentSectionQuestions[currentSection];
    if (sectionQuestions) {
        sectionQuestions.splice(index, 1);
    }
    
    // Refresh the display
    displayQuestions(currentSectionQuestions[currentSection] || [], section);
    
    alert('Question deleted successfully');
} catch (error) {
    console.error('Error deleting question:', error);
    alert('Error deleting question: ' + error.message);
}
}

// Function to add new question
function addNewQuestion(section) {
if (!currentSubmissionData) {
alert('No submission data found. Cannot add new question.');
return;
}


const editContainer = document.getElementById('editQuestionsContainer');

const questionDiv = document.createElement('div');
questionDiv.className = 'editable-question';
questionDiv.dataset.index = 'new';

// Create appropriate fields based on section
switch(section) {
    case 'climateTrends':
        const hazardInput = document.createElement('input');
        hazardInput.type = 'text';
        hazardInput.value = currentSubmissionData.climateHazards ? currentSubmissionData.climateHazards[0] : '';
        hazardInput.id = 'hazard-new';
        hazardInput.placeholder = 'Climate Hazard';
        hazardInput.style.width = '100%';
        hazardInput.style.marginBottom = '5px';
        hazardInput.style.padding = '8px';
        hazardInput.style.border = '1px solid #ccc';
        hazardInput.style.borderRadius = '4px';
        
        const typeInput = document.createElement('input');
        typeInput.type = 'text';
        typeInput.value = '';
        typeInput.id = 'question-new';
        typeInput.placeholder = 'Type of Data to be Collected';
        typeInput.style.width = '100%';
        typeInput.style.marginBottom = '5px';
        typeInput.style.padding = '8px';
        typeInput.style.border = '1px solid #ccc';
        typeInput.style.borderRadius = '4px';
        
        const descTextarea = document.createElement('textarea');
        descTextarea.value = '';
        descTextarea.id = 'description-new';
        descTextarea.placeholder = 'Description';
        descTextarea.style.width = '100%';
        descTextarea.style.minHeight = '60px';
        descTextarea.style.marginBottom = '10px';
        descTextarea.style.padding = '8px';
        descTextarea.style.border = '1px solid #ccc';
        descTextarea.style.borderRadius = '4px';
        descTextarea.style.resize = 'vertical';
        
        questionDiv.appendChild(hazardInput);
        questionDiv.appendChild(typeInput);
        questionDiv.appendChild(descTextarea);
        break;
        
    case 'diseaseHazards':
        const hazardInput2 = document.createElement('input');
        hazardInput2.type = 'text';
        hazardInput2.value = currentSubmissionData.climateHazards ? currentSubmissionData.climateHazards[0] : '';
        hazardInput2.id = 'hazard-new';
        hazardInput2.placeholder = 'Climate Hazard';
        hazardInput2.style.width = '100%';
        hazardInput2.style.marginBottom = '5px';
        hazardInput2.style.padding = '8px';
        hazardInput2.style.border = '1px solid #ccc';
        hazardInput2.style.borderRadius = '4px';
        
        const diseaseInput = document.createElement('input');
        diseaseInput.type = 'text';
        diseaseInput.value = currentSubmissionData.diseases ? currentSubmissionData.diseases[0] : '';
        diseaseInput.id = 'disease-new';
        diseaseInput.placeholder = 'Disease Category';
        diseaseInput.style.width = '100%';
        diseaseInput.style.marginBottom = '5px';
        diseaseInput.style.padding = '8px';
        diseaseInput.style.border = '1px solid #ccc';
        diseaseInput.style.borderRadius = '4px';
        
        const indicatorsTextarea = document.createElement('textarea');
        indicatorsTextarea.value = '';
        indicatorsTextarea.id = 'indicators-new';
        indicatorsTextarea.placeholder = 'Indicators to Follow';
        indicatorsTextarea.style.width = '100%';
        indicatorsTextarea.style.minHeight = '60px';
        indicatorsTextarea.style.marginBottom = '10px';
        indicatorsTextarea.style.padding = '8px';
        indicatorsTextarea.style.border = '1px solid #ccc';
        indicatorsTextarea.style.borderRadius = '4px';
        indicatorsTextarea.style.resize = 'vertical';
        
        questionDiv.appendChild(hazardInput2);
        questionDiv.appendChild(diseaseInput);
        questionDiv.appendChild(indicatorsTextarea);
        break;
        
    case 'fgd':
        const hazardInput3 = document.createElement('input');
        hazardInput3.type = 'text';
        hazardInput3.value = currentSubmissionData.climateHazards ? currentSubmissionData.climateHazards[0] : '';
        hazardInput3.id = 'hazard-new';
        hazardInput3.placeholder = 'Climate Hazard';
        hazardInput3.style.width = '100%';
        hazardInput3.style.marginBottom = '5px';
        hazardInput3.style.padding = '8px';
        hazardInput3.style.border = '1px solid #ccc';
        hazardInput3.style.borderRadius = '4px';
        
        const questionInput = document.createElement('textarea');
        questionInput.value = '';
        questionInput.id = 'question-new';
        questionInput.placeholder = 'Question';
        questionInput.style.width = '100%';
        questionInput.style.minHeight = '60px';
        questionInput.style.marginBottom = '5px';
        questionInput.style.padding = '8px';
        questionInput.style.border = '1px solid #ccc';
        questionInput.style.borderRadius = '4px';
        questionInput.style.resize = 'vertical';
        
        const probesTextarea = document.createElement('textarea');
        probesTextarea.value = '';
        probesTextarea.id = 'probes-new';
        probesTextarea.placeholder = 'Potential Probes/Follow-ups';
        probesTextarea.style.width = '100%';
        probesTextarea.style.minHeight = '60px';
        probesTextarea.style.marginBottom = '10px';
        probesTextarea.style.padding = '8px';
        probesTextarea.style.border = '1px solid #ccc';
        probesTextarea.style.borderRadius = '4px';
        probesTextarea.style.resize = 'vertical';
        
        questionDiv.appendChild(hazardInput3);
        questionDiv.appendChild(questionInput);
        questionDiv.appendChild(probesTextarea);
        break;
        
    case 'kii':
    case 'hfva':
    case 'survey':
    default:
        const hazardInput4 = document.createElement('input');
        hazardInput4.type = 'text';
        hazardInput4.value = currentSubmissionData.climateHazards ? currentSubmissionData.climateHazards[0] : '';
        hazardInput4.id = 'hazard-new';
        hazardInput4.placeholder = 'Climate Hazard';
        hazardInput4.style.width = '100%';
        hazardInput4.style.marginBottom = '5px';
        hazardInput4.style.padding = '8px';
        hazardInput4.style.border = '1px solid #ccc';
        hazardInput4.style.borderRadius = '4px';
        
        const questionTextarea = document.createElement('textarea');
        questionTextarea.value = '';
        questionTextarea.id = 'question-new';
        questionTextarea.placeholder = 'Question';
        questionTextarea.style.width = '100%';
        questionTextarea.style.minHeight = '60px';
        questionTextarea.style.marginBottom = '10px';
        questionTextarea.style.padding = '8px';
        questionTextarea.style.border = '1px solid #ccc';
        questionTextarea.style.borderRadius = '4px';
        questionTextarea.style.resize = 'vertical';
        
        questionDiv.appendChild(hazardInput4);
        questionDiv.appendChild(questionTextarea);
}

const buttonsDiv = document.createElement('div');
buttonsDiv.className = 'buttons';

const saveBtn = document.createElement('button');
saveBtn.className = 'save-btn';
saveBtn.textContent = 'Save';
saveBtn.onclick = function() { saveNewQuestion(section); };

const cancelBtn = document.createElement('button');
cancelBtn.textContent = 'Cancel';
cancelBtn.style.backgroundColor = '#f0f0f0';
cancelBtn.style.color = '#333';
cancelBtn.onclick = function() {
    editContainer.removeChild(questionDiv);
};

buttonsDiv.appendChild(saveBtn);
buttonsDiv.appendChild(cancelBtn);
questionDiv.appendChild(buttonsDiv);

// Insert before the "Add New Question" button
editContainer.insertBefore(questionDiv, editContainer.lastChild);
}

// Function to save new question
async function saveNewQuestion(section) {
try {
// Get the collection for this section
const collectionName = sectionCollections[section] || 'Survey_';


    // Create question data object based on section
    const questionData = {
        timestamp: new Date().toISOString()
    };
    
    switch(section) {
        case 'climateTrends':
            questionData.climateHazards = document.getElementById('hazard-new').value.trim();
            questionData.typeOfData = document.getElementById('question-new').value.trim();
            questionData.description = document.getElementById('description-new').value.trim();
            
            // Validate required fields
            if (!questionData.typeOfData || !questionData.description) {
                alert('Type of Data and Description are required');
                return;
            }
            break;
            
        case 'diseaseHazards':
            questionData.climateHazards = document.getElementById('hazard-new').value.trim();
            questionData.diseaseCategory = document.getElementById('disease-new').value.trim();
            questionData.indicatorsToFollow = document.getElementById('indicators-new').value.trim();
            
            // Validate required fields
            if (!questionData.diseaseCategory || !questionData.indicatorsToFollow) {
                alert('Disease Category and Indicators are required');
                return;
            }
            break;
            
        case 'fgd':
            questionData.climateHazards = document.getElementById('hazard-new').value.trim();
            questionData.question = document.getElementById('question-new').value.trim();
            questionData.potentialProbes = document.getElementById('probes-new').value.trim();
            
            // Validate required fields
            if (!questionData.question) {
                alert('Question is required');
                return;
            }
            break;
            
        case 'kii':
        case 'hfva':
        case 'survey':
        default:
            questionData.climateHazards = document.getElementById('hazard-new').value.trim();
            questionData.question = document.getElementById('question-new').value.trim();
            
            // Validate required fields
            if (!questionData.question) {
                alert('Question is required');
                return;
            }
    }
    
    // Add to Firestore
    const docRef = await db.collection(collectionName).add(questionData);
    
    // Add to local data
    if (!currentSectionQuestions[currentSection]) {
        currentSectionQuestions[currentSection] = [];
    }
    
    currentSectionQuestions[currentSection].push({
        id: docRef.id,
        ...questionData
    });
    
    // Refresh the display
    displayQuestions(currentSectionQuestions[currentSection], section);
    
    alert('New question added successfully');
} catch (error) {
    console.error('Error adding new question:', error);
    alert('Error adding new question: ' + error.message);
}
}

// Function to save all changes
async function saveAllChanges() {
try {
const promises = [];
const editableQuestions = document.querySelectorAll('.editable-question');


    for (const questionDiv of editableQuestions) {
        const id = questionDiv.dataset.id;
        const index = questionDiv.dataset.index;
        
        // Skip new questions
        if (index === 'new' || !id) continue;
        
        // Get the collection for this section
        const collectionName = sectionCollections[currentSection] || 'Survey_';
        
        // Create update data object based on section
        const updateData = {};
        
        switch(currentSection) {
            case 'climateTrends':
                updateData.climateHazards = document.getElementById(`hazard-${index}`).value.trim();
                updateData.typeOfData = document.getElementById(`question-${index}`).value.trim();
                updateData.description = document.getElementById(`description-${index}`).value.trim();
                break;
                
            case 'diseaseHazards':
                updateData.climateHazards = document.getElementById(`hazard-${index}`).value.trim();
                updateData.diseaseCategory = document.getElementById(`disease-${index}`).value.trim();
                updateData.indicatorsToFollow = document.getElementById(`indicators-${index}`).value.trim();
                break;
                
            case 'fgd':
                updateData.climateHazards = document.getElementById(`hazard-${index}`).value.trim();
                updateData.question = document.getElementById(`question-${index}`).value.trim();
                updateData.potentialProbes = document.getElementById(`probes-${index}`).value.trim();
                break;
                
            case 'kii':
            case 'hfva':
            case 'survey':
            default:
                updateData.climateHazards = document.getElementById(`hazard-${index}`).value.trim();
                updateData.question = document.getElementById(`question-${index}`).value.trim();
        }
        
        // Update the question in Firestore
        promises.push(db.collection(collectionName).doc(id).update(updateData));
        
        // Update local data
        const sectionQuestions = currentSectionQuestions[currentSection];
        if (sectionQuestions && sectionQuestions[index]) {
            Object.assign(sectionQuestions[index], updateData);
        }
    }
    
    await Promise.all(promises);
    alert('All changes saved successfully');
    
    // Refresh the display
    displayQuestions(currentSectionQuestions[currentSection] || [], currentSection);
} catch (error) {
    console.error('Error saving all changes:', error);
    alert('Error saving changes: ' + error.message);
}
}

// Function to export assessment
function exportAssessment() {
if (!currentSubmissionData) {
alert('No assessment data to export');
return;
}


let exportText = 'CLIMATE HEALTH ASSESSMENT\n\n';
exportText += `Date: ${new Date(currentSubmissionData.timestamp).toLocaleDateString()}\n`;
exportText += `Climate Hazards: ${formatArrayForDisplay(currentSubmissionData.climateHazards)}\n`;
exportText += `Diseases: ${formatArrayForDisplay(currentSubmissionData.diseases)}\n`;
exportText += `Regions: ${formatArrayForDisplay(currentSubmissionData.regions)}\n`;
exportText += `Domestic (Canada): ${formatArrayForDisplay(currentSubmissionData.domestic)}\n\n`;

// Add questions for each section
Object.keys(currentSectionQuestions).forEach(section => {
    const questions = currentSectionQuestions[section];
    if (questions && questions.length > 0) {
        exportText += `${getSectionTitle(section)} QUESTIONS:\n`;
        
        if (section === 'climateTrends') {
            questions.forEach((q, i) => {
                exportText += `${i+1}. Type: ${q.typeOfData || ''}\n`;
                exportText += `   Description: ${q.description || ''}\n\n`;
            });
        } else if (section === 'diseaseHazards') {
            questions.forEach((q, i) => {
                exportText += `${i+1}. Disease Category: ${q.diseaseCategory || ''}\n`;
                exportText += `   Indicators: ${q.indicatorsToFollow || ''}\n\n`;
            });
        } else if (section === 'fgd') {
            questions.forEach((q, i) => {
                exportText += `${i+1}. Question: ${q.question || ''}\n`;
                exportText += `   Probes: ${q.potentialProbes || ''}\n\n`;
            });
        } else {
            questions.forEach((q, i) => {
                exportText += `${i+1}. ${q.question || ''}\n`;
            });
        }
        
        exportText += '\n';
    }
});

// Create a download link
const blob = new Blob([exportText], { type: 'text/plain' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'climate_health_assessment.txt';
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
}

// Helper function to format values
function formatValue(value) {
if (!value) return '';


// Convert snake_case to Title Case
if (typeof value === 'string') {
    return value.split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
} else if (Array.isArray(value)) {
    return value.map(item => formatValue(item)).join(', ');
}

return value.toString();
}

// Function to check database structure
async function checkDatabaseStructure() {
try {
console.log("Checking database structure...");


    // Check each collection
    for (const [section, collectionName] of Object.entries(sectionCollections)) {
        const snapshot = await db.collection(collectionName).limit(1).get();
        console.log(`${collectionName} exists:`, !snapshot.empty);
        
        if (!snapshot.empty) {
            snapshot.forEach(doc => {
                console.log(`Sample ${collectionName} document:`, doc.data());
            });
        }
    }
} catch (error) {
    console.error("Error checking database structure:", error);
}
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Check database structure (for debugging)
    checkDatabaseStructure();
    
    // Get submission ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const submissionId = urlParams.get('submissionId');
    
    console.log("URL Parameters:", window.location.search);
    console.log("Submission ID from URL:", submissionId);
    
    if (submissionId) {
        currentSubmissionId = submissionId;
        console.log("Loading assessment details for ID:", submissionId);
        loadAssessmentDetails(submissionId);
    } else {
        document.getElementById('assessmentDetails').innerHTML = 
            '<p>No submission ID found. Please go back to the input form and submit your selections.</p>';
    }
    
    // Add event listener for save all button
    document.getElementById('saveAllQuestionsBtn').addEventListener('click', saveAllChanges);
});


    </script>
</body>
</html>

