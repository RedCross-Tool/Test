<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Health Assessment</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f4f4f9;
        color: #333;
    }
    header {
        text-align: center;
        padding: 20px;
        background: #ED1B2E;
        color: white;
        position: relative;
    }
    .logo {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
    }
    .container {
        max-width: 1200px;
        margin: 20px auto;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: space-between;
    }
    .box {
        flex: 1 1 calc(33.33% - 20px);
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        text-align: center;
        display: flex;
        flex-direction: column;
    }
    .box img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    .box h3 {
        background: #ED1B2E;
        color: white;
        margin: 0;
        padding: 10px;
    }
    .box .content {
        padding: 10px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .box .actions {
        display: flex;
        justify-content: space-around;
        padding: 10px;
    }
    .box button {
        background: #ED1B2E;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s ease;
    }
    .box button:hover {
        background: #C41522;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        position: relative; /* Added for X button positioning */
        background: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        text-align: left;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        max-height: 80vh;
        overflow-y: auto;
    }
    
    /* Modal header with X button */
    .modal-header {
        background: #ED1B2E;
        color: white;
        padding: 10px 15px;
        margin: -20px -20px 15px -20px;
        border-radius: 8px 8px 0 0;
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h4 {
        margin: 0;
        flex-grow: 1;
        text-align: center;
    }
    
    .close-x {
        color: white;
        background: none;
        border: none;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s ease;
    }
    
    .close-x:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .modal-content p, .modal-content ul {
        margin: 10px 0;
    }
    .modal-content ul {
        padding-left: 20px;
        list-style: disc;
    }
    .modal-content button {
        display: block;
        margin: 20px auto 0;
        padding: 10px 15px;
        background: #ED1B2E;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .export-form {
        text-align: center;
        margin-top: 20px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .export-form button {
        background: #ED1B2E;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s ease;
    }
    .export-form button:hover {
        background: #C41522;
    }
    .question-item {
        margin-bottom: 15px;
        padding: 10px;
        border-left: 3px solid #ED1B2E;
        background: #f9f9f9;
    }
    .questions-container {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 15px;
    }
    .editable-question {
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #f9f9f9;
    }
    .editable-question textarea {
        width: 100%;
        min-height: 60px;
        margin-bottom: 10px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: vertical;
    }
    .editable-question .buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .editable-question button {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .editable-question .save-btn {
        background: #4CAF50;
        color: white;
    }
    .editable-question .delete-btn {
        background: #f44336;
        color: white;
    }
    .assessment-info {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin: 20px auto;
        max-width: 1200px;
    }
    footer {
        text-align: center;
        padding: 10px;
        background: #ED1B2E;
        color: white;
        margin-top: 30px;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

</head>
<body>
    <header>
        <h1>Climate Health Assessment</h1>
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRvju8KVWOA26EEHzvXjwEG4OIWNBauaBmvK11oEeaaf8u8j35cUzQplyGPt4Iy22J_Uqk&usqp=CAU" alt="Logo" class="logo">
    </header>

    <div class="assessment-info">
        <h2>Your Assessment Details</h2>
        <div id="assessmentDetails">
            <p>Loading assessment details...</p>
        </div>
    </div>
    <div class="container">
        <div class="box">
            <img src="https://cdn.redcross.ca/prodmedia/crc/azure/volunteer/emergency-responder-cta-thumbnail.jpg?ext=.jpg" alt="Survey">
            <h3>Survey</h3>
            <div class="content">
                <p>This survey, developed by CRC, collects information on the intersection between climate and health, residents' experiences with extreme weather events, and climate-related vulnerabilities.</p>
                <div class="actions">
                    <button onclick="showModal('surveyMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('survey')">Review Questions</button>
                </div>
            </div>
        </div>

        <div class="box">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZqsyqbp7oJDrumNi_aFGhCx_XkTiTPK_ZHw&s" alt="Key Informant Interview">
            <h3>Key Informant Interviews</h3>
            <div class="content">
                <p>This component gathers expert insights on the impact of climate change on health from various stakeholders and organizations.</p>
                <div class="actions">
                    <button onclick="showModal('kiiMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('kii')">Review Questions</button>
                </div>
            </div>
        </div>

        <div class="box">
            <img src="https://cdn.redcross.ca/prodmedia/crc/img/How-We-Help/Emergencies-and-Disasters-in-Canada/Les-benevoles.jpg" alt="Focus Group Discussion">
            <h3>Focus Group Discussion</h3>
            <div class="content">
                <p>This tool collects diverse views on the effects of climate change on health through structured group discussions.</p>
                <div class="actions">
                    <button onclick="showModal('fgdMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('fgd')">Review Questions</button>
                </div>
            </div>
        </div>

        <div class="box">
            <img src="https://cdn.redcross.ca/prodmedia/crc/img/recruitment.jpg" alt="Health Facilities Vulnerability Assessment">
            <h3>Health Facilities Vulnerability Assessment</h3>
            <div class="content">
                <p>This component assesses the vulnerability of health facilities to climate hazards using WHO-identified criteria.</p>
                <div class="actions">
                    <button onclick="showModal('hfvaMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('hfva')">Review Questions</button>
                </div>
            </div>
        </div>

        <div class="box">
            <img src="https://cdn.redcross.ca/prodmedia/crc/imgfr/Dans-votre-collectivite/Quebec/Website-Flood-2023-QC.jpg" alt="Climate Trends">
            <h3>Climate Trends</h3>
            <div class="content">
                <p>This section outlines key areas to be monitored during data collection to measure and analyze the impacts of climate change.</p>
                <div class="actions">
                    <button onclick="showModal('climateTrendsMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('climateTrends')">Review Questions</button>
                </div>
            </div>
        </div>

        <div class="box">
            <img src="https://cdn.redcross.ca/prodmedia/crc/img/Volunteer/220118VR-VR-Portal-Emergency-Thumbnails-Emergency-Supervisor.jpg?ext=.jpg" alt="Disease per Climate Hazards">
            <h3>Disease per Climate Hazards</h3>
            <div class="content">
                <p>This table categorizes various climate hazards and their associated disease categories, outlining specific indicators to monitor.</p>
                <div class="actions">
                    <button onclick="showModal('diseaseHazardsMethodology')">View Methodology</button>
                    <button onclick="showQuestionsModal('diseaseHazards')">Review Questions</button>
                </div>
            </div>
        </div>
    </div>
    <div id="surveyMethodology" class="modal">
    <div class="modal-content">
        <h4>Survey Methodology</h4>
        <p>Study Design: Community-based, cross-sectional survey.</p>
        <p>Study Setting: First, choose a district from a certain country, and then focus on a particular region in the selected district.</p>
        <p>Sample Size: Determine the target population within the chosen area and calculate the sample size using probability proportional to size (PPS) sampling based on the population and the desired level of precision. The formula for calculating the sample size for your survey so that the results are statistically significant is: n=N/(1+N(e^2))</p>
        <p>where:</p>
        <ul>
            <li>n is the sample size</li>
            <li>N is the population size</li>
            <li>e is the level of precision (often called the margin of error)</li>
        </ul>
        <p>Sampling Technique: Multi-stage random sampling to select participating wards and households.</p>
        <p>Recruitment: A standard questionnaire is distributed to either the head of the household or to adult residents to collect information on family characteristics, climate change perceptions, and adaptation strategies.</p>
        <p>Data Analysis: The recommended Data collection tool to be used is the Microsoft forms or KOBO tool, which will be entered into a statistical package or Microsoft Excel and then presented in tables, graphs, and charts.</p>
        <!-- Removed the bottom close button -->
    </div>
</div>



    <div id="kiiMethodology" class="modal">
        <div class="modal-content">
            <h4>Key Informant Interview Methodology</h4>
            <p>1. Description:</p>
            <ul>
                <li>Conduct X interviews with participants from government/ Community and other organizations to find out the capacity of the health system in addressing climate change.</li>
                <li>Interviews should be between 45-60 minutes in length.</li>
                <li>Consent to be recorded from participants during interview.</li>
            </ul>
            <p>2. Recruitment:</p>
            <ul>
                <li>Purposive sampling based on secondary data collection.</li>
                <li>Recruitment of stakeholders involved in climate change, including:</li>
                <ul>
                    <li>Local government/ Community leaders</li>
                    <li>Key informants (project officers or managers) in NGOs and INGOs</li>
                    <li>Local health authorities</li>
                    <li>Climate change advocates and academics</li>
                </ul>
            </ul>
            <p>3. Data Collection:</p>
            <ul>
                <li>Semi-structured interviews to allow in-depth discussions.</li>
                <li>Translator assistance for interviews when needed.</li>
            </ul>
            <p>4. Data Analysis:</p>
            <ul>
                <li>The interviews to be done with consent and are to be recorded and then transcribed.</li>
                <li>The data will be coded and grouped into themes and sub-themes.</li>
                <li>Internal triangulation to ensure trustworthiness, through collective discussion and refinement of themes by the project team.</li>
            </ul>
            <button onclick="closeModal('kiiMethodology')">Close</button>
        </div>
    </div>

    <div id="fgdMethodology" class="modal">
        <div class="modal-content">
            <h4>Focus Group Discussion Methodology</h4>
            <p>Purpose:</p>
            <ul>
                <li>To gather community insights on climate change threats, vulnerabilities, and response capacities.</li>
                <li>To understand how climate change impacts health and identify areas for improvement.</li>
            </ul>
            <p>Procedure:</p>
            <ul>
                <li>The group interviews should be conducted for 90 minutes, and each group should have 6-10 participants.</li>
                <li>A facilitator to lead the discussion and note takes place to write down ideas provided by participants.</li>
                <li>The discussions will be audio recorded only if the participants agree to allow the researcher to capture all the information in full. The recordings will remain inaccessible to anyone outside the research team.</li>
                <li>It is entirely voluntary to participate, and anyone can leave the study at any time without any consequences.</li>
            </ul>
            <p>Confidentiality:</p>
            <ul>
                <li>Participants' privacy to be observed and all information collected should be used only for the purpose of this study and should be treated with confidentiality.</li>
                <li>Data should be analyzed anonymously, and no participant will be identified in the results of the study.</li>
                <li>The study records including consent forms to be kept in a safe place and can only be accessed by the designated authorized staff.</li>
            </ul>
            <p>Recruitment:</p>
            <ul>
                <li>Purposive/convenience sampling will be used to select participants according to their interest and knowledge of climate change.</li>
                <li>A screening interview will also be done to establish the eligibility of the participants.</li>
                <li>The participants should be above X years and should be involved in community health efforts but not in public health or medical professional employment.</li>
                <li>Attempts will be made to incorporate participants with different levels of climate change awareness.</li>
            </ul>
            <p>Data Collection:</p>
            <ul>
                <li>Topics include community health, climate change impacts, knowledge gaps and future strategies in relation to climate change and health.</li>
                <li>In addition, non-verbal responses will also be collected during the discussion to include all the possible participant inputs.</li>
            </ul>
            <p>Data Analysis:</p>
            <ul>
                <li>The discussions will be recorded and where possible transcribed and translated.</li>
                <li>To identify key themes and sub-themes, a thematic analysis will be conducted.</li>
                <li>Triangulation will be internal, where several team members analyze the data independently and then collectively refine the themes for trustworthiness and consistency.</li>
            </ul>
            <button onclick="closeModal('fgdMethodology')">Close</button>
        </div>
    </div>
    
    <div id="hfvaMethodology" class="modal">
        <div class="modal-content">
            <h4>Health Facilities Vulnerability Assessment Methodology</h4>
            <p>This component represents a full-fledged checklist of vulnerability of health facilities as identified by the World Health Organization (WHO). It classifies different climate hazards and their corresponding health impacts then lists the criteria and questions to determine the readiness and robustness of health facilities. This checklist when used by researchers and analysts will help in a more systematic collection of data, and determination of risks and effects of various climate hazards. This is a more systematic way of approaching the vulnerabilities in health facilities and thus leads to better risk management and adaptation decisions.</p>
            <button onclick="closeModal('hfvaMethodology')">Close</button>
        </div>
    </div>

    <div id="climateTrendsMethodology" class="modal">
        <div class="modal-content">
            <h4>Climate Trends Methodology</h4>
            <p>In order to properly measure and analyse the impacts of climate change the following key areas will be monitored during the data collection process.</p>
            <p>This table provides a systematic approach for identifying the types of data required for analysing trends in climate hazards and their explanations. It helps in identifying the data that needs to be tracked and evaluated for every climate hazard of concern. Using this table, researchers and analysts can consistently obtain the right data to make evaluations of the effects and trends of the various climate hazards. This is a more systematic way of approaching the analysis of the hazards with the aim of having a better understanding of the hazards and their risks and thus being in a better position to mitigate the risks in question in the best way possible as far as climate risk management and adaptation are concerned.</p>
            <button onclick="closeModal('climateTrendsMethodology')">Close</button>
        </div>
    </div>

    <div id="diseaseHazardsMethodology" class="modal">
        <div class="modal-content">
            <h4>Disease per Climate Hazards Methodology</h4>
            <p>This table is a robust toolkit for climate hazard analysis, categorizing various climate hazards and their associated disease categories. It outlines the specific indicators to monitor for each disease category, to help researchers and analysts gather the right data in a systematic way. This table is useful for identifying and assessing the impacts and trends related to different climate hazards, and this structured approach helps us better understand the health implications of climate hazards and better inform risk management and adaptation strategies.</p>
            <button onclick="closeModal('diseaseHazardsMethodology')">Close</button>
        </div>
    </div>
    <!-- Questions Modal for all sections -->
   <div id="questionsModal" class="modal">
    <div class="modal-content">
        <h4 id="questionsModalTitle">Section Questions</h4>
        <div id="questionsContainer" class="questions-container">
            <p>Loading questions...</p>
        </div>
        <div id="editQuestionsContainer"></div>
        <div style="display: flex; justify-content: space-between;">
            <button id="addNewQuestionBtn" style="background-color: #007BFF;">Add New Question</button>
            <button id="saveAllQuestionsBtn" style="background-color: #4CAF50;">Save and Exit</button>
        </div>
    </div>
</div>

    <div class="export-form">
        <button onclick="exportAssessment()">Export Assessment</button>
        <button onclick="generateSolutions()">Generate Solutions</button>
    </div>

    <footer>
        &copy; 2025 Global Health in Emergency Research Team
    </footer>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <script>
        // PART 1: INITIALIZATION AND SETUP
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDurfWVGVnIIfbc0plLD5sPp-VPyv8j3SQ",
            authDomain: "canadian-red-cross-cc-app.firebaseapp.com",
            projectId: "canadian-red-cross-cc-app",
            storageBucket: "canadian-red-cross-cc-app.firebasestorage.app",
            messagingSenderId: "142442090355",
            appId: "1:142442090355:web:447b25a0487d8ba9f83f06",
            measurementId: "G-1C3RCZX1NV"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentSubmissionId = null;
        let currentSubmissionData = null;
        let currentSectionQuestions = {};
        let currentSection = null;

        // Collection mapping for each section
        const sectionCollections = {
            'survey': 'Survey',
            'kii': 'KII',
            'fgd': 'FGD',
            'hfva': 'WHO_Hazards_Checklis',
            'climateTrends': 'Meteorological_indicators',
            'diseaseHazards': 'Disease_indicators'
        };

        // PART 2: UTILITY FUNCTIONS
        // Function to inspect a document and identify field names
        function inspectDocument(doc) {
            const data = doc.data();
            const fields = Object.keys(data);
            
            console.log(`Document ID: ${doc.id}`);
            console.log(`Fields: ${fields.join(', ')}`);
            
            // Look for fields related to climate hazards
            const hazardFields = fields.filter(field => 
                field.toLowerCase().includes('climate') || 
                field.toLowerCase().includes('hazard')
            );
            
            if (hazardFields.length > 0) {
                console.log(`Potential climate hazard fields: ${hazardFields.join(', ')}`);
                hazardFields.forEach(field => {
                    console.log(`  ${field}: ${JSON.stringify(data[field])}`);
                });
            }
            
            // Look for fields related to diseases
            const diseaseFields = fields.filter(field => 
                field.toLowerCase().includes('disease') || 
                field.toLowerCase().includes('health')
            );
            
            if (diseaseFields.length > 0) {
                console.log(`Potential disease fields: ${diseaseFields.join(', ')}`);
                diseaseFields.forEach(field => {
                    console.log(`  ${field}: ${JSON.stringify(data[field])}`);
                });
            }
            
            return { hazardFields, diseaseFields };
        }

      // Modal functions
function showModal(id) {
    // Show the modal
    document.getElementById(id).style.display = 'flex';
    
    // Get the modal content and title
    const modalContent = document.querySelector(`#${id} .modal-content`);
    const modalTitle = modalContent.querySelector('h4').textContent;
    
    // Create header with X button if it doesn't exist
    if (!modalContent.querySelector('.modal-header')) {
        // Remove the existing h4 element
        modalContent.querySelector('h4').remove();
        
        // Create new header
        const modalHeader = document.createElement('div');
        modalHeader.className = 'modal-header';
        
        // Add title
        const titleElement = document.createElement('h4');
        titleElement.textContent = modalTitle;
        modalHeader.appendChild(titleElement);
        
        // Add X button
        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-x';
        closeBtn.innerHTML = '&times;'; // × symbol
        closeBtn.onclick = function() { closeModal(id); };
        modalHeader.appendChild(closeBtn);
        
        // Insert header at the beginning of modal content
        modalContent.insertBefore(modalHeader, modalContent.firstChild);
    }
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

// Function to show questions modal for a specific section
function showQuestionsModal(section) {
    currentSection = section;

    // Set up the modal content
    const modalContent = document.querySelector('#questionsModal .modal-content');

    // Clear existing content
    modalContent.innerHTML = '';

    // Create header with title and X button
    const modalHeader = document.createElement('div');
    modalHeader.className = 'modal-header';

    const titleElement = document.createElement('h4');
    titleElement.id = 'questionsModalTitle';
    titleElement.textContent = getSectionTitle(section) + ' Questions';
    modalHeader.appendChild(titleElement);

    const closeBtn = document.createElement('button');
    closeBtn.className = 'close-x';
    closeBtn.innerHTML = '&times;'; // × symbol
    closeBtn.onclick = function () { closeModal('questionsModal'); };
    modalHeader.appendChild(closeBtn);

    // Add header to modal
    modalContent.appendChild(modalHeader);

    // Create containers for questions and edit forms
    const questionsContainer = document.createElement('div');
    questionsContainer.id = 'questionsContainer';
    questionsContainer.className = 'questions-container';
    questionsContainer.innerHTML = '<p>Loading questions...</p>';
    modalContent.appendChild(questionsContainer);

    const editContainer = document.createElement('div');
    editContainer.id = 'editQuestionsContainer';
    modalContent.appendChild(editContainer);

    // Add save and add buttons
    const buttonDiv = document.createElement('div');
    buttonDiv.style.display = 'flex';
    buttonDiv.style.justifyContent = 'space-between';

    const addNewBtn = document.createElement('button');
    addNewBtn.id = 'addNewQuestionBtn';
    addNewBtn.textContent = 'Add New Question';
    addNewBtn.style.backgroundColor = '#007BFF';
    addNewBtn.style.color = 'white';
    addNewBtn.style.border = 'none';
    addNewBtn.style.padding = '10px 20px';
    addNewBtn.style.borderRadius = '4px';
    addNewBtn.style.cursor = 'pointer';
    addNewBtn.onclick = addNewQuestion;

    const saveAllBtn = document.createElement('button');
    saveAllBtn.id = 'saveAllQuestionsBtn';
    saveAllBtn.textContent = 'Save and Exit';
    saveAllBtn.style.backgroundColor = '#4CAF50';
    saveAllBtn.style.color = 'white';
    saveAllBtn.style.border = 'none';
    saveAllBtn.style.padding = '10px 20px';
    saveAllBtn.style.borderRadius = '4px';
    saveAllBtn.style.cursor = 'pointer';
    saveAllBtn.onclick = saveAllChanges;

    buttonDiv.appendChild(addNewBtn);
    buttonDiv.appendChild(saveAllBtn);
    modalContent.appendChild(buttonDiv);

    // Show the modal
    showModal('questionsModal');

    if (currentSubmissionId) {
        // First, check localStorage for saved data
        const savedData = localStorage.getItem(`questions_${currentSubmissionId}`);
        if (savedData) {
            console.log('Loaded questions from localStorage for section:', section);
            currentSectionQuestions = JSON.parse(savedData);
            const sectionQuestions = currentSectionQuestions[section] || [];
            displayAllQuestions(sectionQuestions, section);
            createEditableQuestions(sectionQuestions, editContainer, section);
        } else {
            // If no saved data, fetch from Firebase
            loadQuestionsForSection(section, currentSubmissionId);
        }
    } else {
        document.getElementById('questionsContainer').innerHTML =
            '<p>No submission data found. Please go back to the input form and submit your selections.</p>';
    }
}

// Function to load questions for a specific section from Firebase
async function loadQuestionsForSection(section, submissionId) {
    try {
        const collectionName = sectionCollections[section] || 'Survey';
        document.getElementById('questionsContainer').innerHTML = `<p>Loading questions from ${collectionName}...</p>`;
        console.log(`Attempting to load questions from collection: ${collectionName}`);

        const selectedHazards = currentSubmissionData.climateHazards || [];
        const selectedDiseases = currentSubmissionData.diseases || [];
        console.log(`Selected climate hazards: ${selectedHazards.join(', ')}`);
        console.log(`Selected diseases: ${selectedDiseases.join(', ')}`);

        let questionsSnapshot = await db.collection(collectionName).get();
        let allQuestions = [];
        let filteredQuestions = [];

        questionsSnapshot.forEach(doc => {
            const questionData = { id: doc.id, ...doc.data() };
            allQuestions.push(questionData);

            let includeBasedOnHazard = false;
            let includeBasedOnDisease = false;

            if (questionData.climateHazards) {
                const questionHazard = questionData.climateHazards;
                if (Array.isArray(questionHazard)) {
                    includeBasedOnHazard = questionHazard.some(hazard =>
                        hazard.toLowerCase() === 'all' ||
                        selectedHazards.some(selectedHazard =>
                            hazard.toLowerCase().includes(selectedHazard.toLowerCase())
                        )
                    );
                } else if (typeof questionHazard === 'string') {
                    includeBasedOnHazard =
                        questionHazard.toLowerCase() === 'all' ||
                        selectedHazards.some(hazard =>
                            questionHazard.toLowerCase().includes(hazard.toLowerCase())
                        );
                }
            } else {
                includeBasedOnHazard = true;
            }

            if (questionData.diseaseCategory) {
                const diseaseCategory = questionData.diseaseCategory;
                if (Array.isArray(diseaseCategory)) {
                    includeBasedOnDisease = diseaseCategory.some(disease =>
                        disease.toLowerCase() === 'all' ||
                        selectedDiseases.some(selectedDisease =>
                            disease.toLowerCase().includes(selectedDisease.toLowerCase())
                        )
                    );
                } else if (typeof diseaseCategory === 'string') {
                    includeBasedOnDisease =
                        diseaseCategory.toLowerCase() === 'all' ||
                        selectedDiseases.some(selectedDisease =>
                            diseaseCategory.toLowerCase().includes(selectedDisease.toLowerCase())
                        );
                }
            } else {
                includeBasedOnDisease = true;
            }

            if (section === 'diseaseHazards') {
                if (includeBasedOnHazard && includeBasedOnDisease) {
                    filteredQuestions.push(questionData);
                }
            } else if (includeBasedOnHazard) {
                filteredQuestions.push(questionData);
            }
        });

        console.log(`Loaded ${allQuestions.length} total questions from ${collectionName}`);
        console.log(`Filtered to ${filteredQuestions.length} questions matching selected hazards/diseases`);

        currentSectionQuestions[section + '_all'] = allQuestions;
        currentSectionQuestions[section] = filteredQuestions;

        // Save the filtered questions to localStorage for future use
        localStorage.setItem(`questions_${submissionId}`, JSON.stringify(currentSectionQuestions));

        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';

        const filterInfo = document.createElement('div');
        filterInfo.style.backgroundColor = '#f8f9fa';
        filterInfo.style.padding = '10px';
        filterInfo.style.marginBottom = '15px';
        filterInfo.style.borderRadius = '4px';
        filterInfo.style.border = '1px solid #ddd';

        filterInfo.innerHTML = `
            <p style="margin: 0 0 10px 0; font-size: 14px;">
                <strong>Filtered by:</strong><br>
                Climate Hazards: ${formatArrayForDisplay(selectedHazards)}<br>
                ${section === 'diseaseHazards' ? `Diseases: ${formatArrayForDisplay(selectedDiseases)}<br>` : ''}
                <span style="font-style: italic; color: #666;">Showing ${filteredQuestions.length} of ${allQuestions.length} questions</span>
            </p>
        `;

        container.appendChild(filterInfo);

        if (filteredQuestions.length === 0) {
            container.innerHTML += '<p>No questions found matching your selected criteria.</p>';
            return;
        }

        displayAllQuestions(filteredQuestions, section);
    } catch (error) {
        console.error(`Error loading questions from ${section}:`, error);
        document.getElementById('questionsContainer').innerHTML = `<p>Error loading questions: ${error.message}</p>`;
    }
}

        // Function to get section title
        function getSectionTitle(section) {
            const titles = {
                'survey': 'Survey',
                'kii': 'Key Informant Interviews',
                'fgd': 'Focus Group Discussion',
                'hfva': 'Health Facilities Vulnerability Assessment',
                'climateTrends': 'Climate Trends',
                'diseaseHazards': 'Disease per Climate Hazards'
            };
            return titles[section] || 'Section';
        }

        // Function to format array for display
        function formatArrayForDisplay(arr) {
            if (!arr || arr.length === 0) return 'None';
            
            return arr.map(item => {
                // Convert snake_case to Title Case
                return item.split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }).join(', ');
        }

        // Helper function to format values properly
        function formatValue(value) {
            if (!value) return '';
            
            if (Array.isArray(value)) {
                return value.join(', ');
            } else if (typeof value === 'string') {
                return value;
            }
            
            return String(value);
        }

        // PART 3: DATA LOADING FUNCTIONS
        // Function to load assessment details based on submission ID
        async function loadAssessmentDetails(submissionId) {
            console.log("loadAssessmentDetails called with ID:", submissionId);
            try {
                console.log("Fetching submission document:", submissionId);
                const submissionDoc = await db.collection('submissions').doc(submissionId).get();
                
                console.log("Document exists:", submissionDoc.exists);
                
                if (!submissionDoc.exists) {
                    document.getElementById('assessmentDetails').innerHTML = 
                        '<p>Submission not found. Please go back to the input form and submit your selections.</p>';
                    return;
                }
                
                currentSubmissionData = submissionDoc.data();
                console.log("Submission data:", currentSubmissionData);
                
                // Display assessment details
                const details = document.getElementById('assessmentDetails');
                details.innerHTML = `
                    <p><strong>Date:</strong> ${new Date(currentSubmissionData.timestamp).toLocaleDateString()}</p>
                    <p><strong>Climate Hazards:</strong> ${formatArrayForDisplay(currentSubmissionData.climateHazards)}</p>
                    <p><strong>Diseases:</strong> ${formatArrayForDisplay(currentSubmissionData.diseases)}</p>
                    <p><strong>Regions:</strong> ${formatArrayForDisplay(currentSubmissionData.regions)}</p>
                    <p><strong>Domestic (Canada):</strong> ${formatArrayForDisplay(currentSubmissionData.domestic)}</p>
                `;
            } catch (error) {
                console.error('Error loading assessment details:', error);
                document.getElementById('assessmentDetails').innerHTML = 
                    `<p>Error loading assessment details: ${error.message}</p>`;
            }
        }

async function loadQuestionsForSection(section, submissionId) {
    try {
        const collectionName = sectionCollections[section] || 'Survey';
        document.getElementById('questionsContainer').innerHTML = `<p>Loading questions from ${collectionName}...</p>`;
        console.log(`Attempting to load questions from collection: ${collectionName}`);

        const selectedHazards = currentSubmissionData.climateHazards || [];
        const selectedDiseases = currentSubmissionData.diseases || [];
        console.log(`Selected climate hazards: ${selectedHazards.join(', ')}`);
        console.log(`Selected diseases: ${selectedDiseases.join(', ')}`);

        let questionsSnapshot = await db.collection(collectionName).get();
        let allQuestions = [];
        let filteredQuestions = [];

        questionsSnapshot.forEach(doc => {
            const questionData = { id: doc.id, ...doc.data() };
            allQuestions.push(questionData);

            let includeBasedOnHazard = false;
            let includeBasedOnDisease = false;

            if (questionData.climateHazards) {
                const questionHazard = questionData.climateHazards;
                if (Array.isArray(questionHazard)) {
                    includeBasedOnHazard = questionHazard.some(hazard =>
                        hazard.toLowerCase() === 'all' ||
                        selectedHazards.some(selectedHazard =>
                            hazard.toLowerCase().includes(selectedHazard.toLowerCase())
                        )
                    );
                } else if (typeof questionHazard === 'string') {
                    includeBasedOnHazard =
                        questionHazard.toLowerCase() === 'all' ||
                        selectedHazards.some(hazard =>
                            questionHazard.toLowerCase().includes(hazard.toLowerCase())
                        );
                }
            } else {
                includeBasedOnHazard = true;
            }

            if (questionData.diseaseCategory) {
                const diseaseCategory = questionData.diseaseCategory;
                if (Array.isArray(diseaseCategory)) {
                    includeBasedOnDisease = diseaseCategory.some(disease =>
                        disease.toLowerCase() === 'all' ||
                        selectedDiseases.some(selectedDisease =>
                            disease.toLowerCase().includes(selectedDisease.toLowerCase())
                        )
                    );
                } else if (typeof diseaseCategory === 'string') {
                    includeBasedOnDisease =
                        diseaseCategory.toLowerCase() === 'all' ||
                        selectedDiseases.some(selectedDisease =>
                            diseaseCategory.toLowerCase().includes(selectedDisease.toLowerCase())
                        );
                }
            } else {
                includeBasedOnDisease = true;
            }

            if (section === 'diseaseHazards') {
                if (includeBasedOnHazard && includeBasedOnDisease) {
                    filteredQuestions.push(questionData);
                }
            } else if (includeBasedOnHazard) {
                filteredQuestions.push(questionData);
            }
        });

        console.log(`Loaded ${allQuestions.length} total questions from ${collectionName}`);
        console.log(`Filtered to ${filteredQuestions.length} questions matching selected hazards/diseases`);

        currentSectionQuestions[section + '_all'] = allQuestions;
        currentSectionQuestions[section] = filteredQuestions;

        sessionStorage.setItem(`${section}_filteredQuestions`, JSON.stringify(filteredQuestions));
        sessionStorage.setItem(`${section}_allQuestions`, JSON.stringify(allQuestions));

        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';

        const filterInfo = document.createElement('div');
        filterInfo.style.backgroundColor = '#f8f9fa';
        filterInfo.style.padding = '10px';
        filterInfo.style.marginBottom = '15px';
        filterInfo.style.borderRadius = '4px';
        filterInfo.style.border = '1px solid #ddd';

        filterInfo.innerHTML = `
            <p style="margin: 0 0 10px 0; font-size: 14px;">
                <strong>Filtered by:</strong><br>
                Climate Hazards: ${formatArrayForDisplay(selectedHazards)}<br>
                ${section === 'diseaseHazards' ? `Diseases: ${formatArrayForDisplay(selectedDiseases)}<br>` : ''}
                <span style="font-style: italic; color: #666;">Showing ${filteredQuestions.length} of ${allQuestions.length} questions</span>
            </p>
        `;

        const toggleQuestionsBtn = document.createElement('button');
        toggleQuestionsBtn.id = 'toggleQuestionsBtn';
        toggleQuestionsBtn.textContent = 'Show All Questions';
        toggleQuestionsBtn.style.background = '#6c757d';
        toggleQuestionsBtn.style.color = 'white';
        toggleQuestionsBtn.style.border = 'none';
        toggleQuestionsBtn.style.padding = '5px 10px';
        toggleQuestionsBtn.style.borderRadius = '4px';
        toggleQuestionsBtn.style.cursor = 'pointer';
        toggleQuestionsBtn.addEventListener('click', function () {
            displayAllQuestions(allQuestions, section);
            toggleQuestionsBtn.style.display = 'none';
            resetFilterBtn.style.display = 'block';
        });

        const resetFilterBtn = document.createElement('button');
        resetFilterBtn.id = 'resetFilterBtn';
        resetFilterBtn.textContent = 'Show Filtered Questions';
        resetFilterBtn.style.background = '#ED1B2E';
        resetFilterBtn.style.color = 'white';
        resetFilterBtn.style.border = 'none';
        resetFilterBtn.style.padding = '5px 10px';
        resetFilterBtn.style.borderRadius = '4px';
        resetFilterBtn.style.cursor = 'pointer';
        resetFilterBtn.style.display = 'none';
        resetFilterBtn.addEventListener('click', function () {
            displayAllQuestions(filteredQuestions, section);
            resetFilterBtn.style.display = 'none';
            toggleQuestionsBtn.style.display = 'block';
        });

        filterInfo.appendChild(toggleQuestionsBtn);
        filterInfo.appendChild(resetFilterBtn);
        container.appendChild(filterInfo);

        if (filteredQuestions.length === 0) {
            container.innerHTML += '<p>No questions found matching your selected criteria.</p>';
            return;
        }

        displayAllQuestions(filteredQuestions, section);
    } catch (error) {
        console.error(`Error loading questions from ${section}:`, error);
        document.getElementById('questionsContainer').innerHTML = `<p>Error loading questions: ${error.message}</p>`;
    }
}


        // PART 4: DISPLAY FUNCTIONS

// Function to display all questions without filtering
function displayAllQuestions(questions, section) {
    const container = document.getElementById('questionsContainer');
    const editContainer = document.getElementById('editQuestionsContainer');
    
    // Keep the filter info div if it exists
    const filterInfo = container.querySelector('div');
    container.innerHTML = '';
    if (filterInfo) {
        container.appendChild(filterInfo);
    }
    
    if (questions.length === 0) {
        container.innerHTML += '<p>No questions found in this section.</p>';
        editContainer.innerHTML = '';
        return;
    }
    
    console.log(`Displaying ${questions.length} questions for section ${section}`);
    
    // Display questions based on section type with customized field handling
    switch(section) {
        case 'climateTrends':
            displayClimateQuestionsTable(questions, container);
            break;
            
        case 'diseaseHazards':
            displayDiseaseIndicatorsTable(questions, container);
            break;
            
        case 'kii':
            displayKIIQuestions(questions, container);
            break;
            
        case 'fgd':
            displayFGDQuestions(questions, container);
            break;
            
        case 'hfva':
            displayHFVAQuestions(questions, container);
            break;
            
        case 'survey':
        default:
            displaySurveyQuestions(questions, container);
    }
    
    // Create editable questions interface
    createEditableQuestions(questions, editContainer, section);
}
// Helper function to check if a value matches any of the selected values
function hasMatchingValue(value, selectedValues) {
    if (!value || !selectedValues || selectedValues.length === 0) {
        return false;
    }
    
    if (Array.isArray(value)) {
        return value.some(item => 
            selectedValues.some(selected => 
                String(item).toLowerCase().includes(String(selected).toLowerCase()) ||
                String(selected).toLowerCase().includes(String(item).toLowerCase())
            )
        );
    } else {
        return selectedValues.some(selected => 
            String(value).toLowerCase().includes(String(selected).toLowerCase()) ||
            String(selected).toLowerCase().includes(String(value).toLowerCase())
        );
    }
}


                // Specialized display functions for each section
        function displayClimateQuestionsTable(questions, container) {
            container.innerHTML = '<h4>Meteorological Data to Collect:</h4>';
            
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '10px';
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const hazardHeader = document.createElement('th');
            hazardHeader.textContent = 'Climate Hazard';
            hazardHeader.style.padding = '8px';
            hazardHeader.style.backgroundColor = '#f2f2f2';
            hazardHeader.style.border = '1px solid #ddd';
            hazardHeader.style.textAlign = 'left';
            
            const typeHeader = document.createElement('th');
            typeHeader.textContent = 'Type of Data to be Collected';
            typeHeader.style.padding = '8px';
            typeHeader.style.backgroundColor = '#f2f2f2';
            typeHeader.style.border = '1px solid #ddd';
            typeHeader.style.textAlign = 'left';
            
            const descHeader = document.createElement('th');
            descHeader.textContent = 'Description';
            descHeader.style.padding = '8px';
            descHeader.style.backgroundColor = '#f2f2f2';
            descHeader.style.border = '1px solid #ddd';
            descHeader.style.textAlign = 'left';
            
            headerRow.appendChild(hazardHeader);
            headerRow.appendChild(typeHeader);
            headerRow.appendChild(descHeader);
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            questions.forEach((item, index) => {
                const row = document.createElement('tr');
                
                const hazardCell = document.createElement('td');
                hazardCell.textContent = formatValue(item.climateHazards || 'N/A');
                hazardCell.style.padding = '8px';
                hazardCell.style.border = '1px solid #ddd';
                
                const typeCell = document.createElement('td');
                typeCell.textContent = item.typeOfData || 'N/A';
                typeCell.style.padding = '8px';
                typeCell.style.border = '1px solid #ddd';
                
                const descCell = document.createElement('td');
                descCell.textContent = item.Description || 'N/A';
                descCell.style.padding = '8px';
                descCell.style.border = '1px solid #ddd';
                
                row.appendChild(hazardCell);
                row.appendChild(typeCell);
                row.appendChild(descCell);
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
        }

        function displayDiseaseIndicatorsTable(questions, container) {
            container.innerHTML = '<h4>Disease Indicators to Monitor:</h4>';
            
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '10px';
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const hazardHeader = document.createElement('th');
            hazardHeader.textContent = 'Climate Hazard';
            hazardHeader.style.padding = '8px';
            hazardHeader.style.backgroundColor = '#f2f2f2';
            hazardHeader.style.border = '1px solid #ddd';
            hazardHeader.style.textAlign = 'left';
            
            const diseaseHeader = document.createElement('th');
            diseaseHeader.textContent = 'Disease Category';
            diseaseHeader.style.padding = '8px';
            diseaseHeader.style.backgroundColor = '#f2f2f2';
            diseaseHeader.style.border = '1px solid #ddd';
            diseaseHeader.style.textAlign = 'left';
            
            const indicatorsHeader = document.createElement('th');
            indicatorsHeader.textContent = 'Indicators to Follow';
            indicatorsHeader.style.padding = '8px';
            indicatorsHeader.style.backgroundColor = '#f2f2f2';
            indicatorsHeader.style.border = '1px solid #ddd';
            indicatorsHeader.style.textAlign = 'left';
            
            headerRow.appendChild(hazardHeader);
            headerRow.appendChild(diseaseHeader);
            headerRow.appendChild(indicatorsHeader);
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            questions.forEach((item, index) => {
                const row = document.createElement('tr');
                
                const hazardCell = document.createElement('td');
                hazardCell.textContent = formatValue(item.climateHazards || 'N/A');
                hazardCell.style.padding = '8px';
                hazardCell.style.border = '1px solid #ddd';
                
                const diseaseCell = document.createElement('td');
                diseaseCell.textContent = formatValue(item.diseaseCategory || 'N/A');
                diseaseCell.style.padding = '8px';
                diseaseCell.style.border = '1px solid #ddd';
                
                const indicatorsCell = document.createElement('td');
                indicatorsCell.textContent = item.indicatorsToFollow || 'N/A';
                indicatorsCell.style.padding = '8px';
                indicatorsCell.style.border = '1px solid #ddd';
                
                row.appendChild(hazardCell);
                row.appendChild(diseaseCell);
                row.appendChild(indicatorsCell);
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
        }

        function displayKIIQuestions(questions, container) {
            container.innerHTML = '<h4>Key Informant Interview Questions:</h4>';
            
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '10px';
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const hazardHeader = document.createElement('th');
            hazardHeader.textContent = 'Climate Hazard';
            hazardHeader.style.padding = '8px';
            hazardHeader.style.backgroundColor = '#f2f2f2';
            hazardHeader.style.border = '1px solid #ddd';
            hazardHeader.style.textAlign = 'left';
            
            const questionHeader = document.createElement('th');
            questionHeader.textContent = 'Question';
            questionHeader.style.padding = '8px';
            questionHeader.style.backgroundColor = '#f2f2f2';
            questionHeader.style.border = '1px solid #ddd';
            questionHeader.style.textAlign = 'left';
            
            headerRow.appendChild(hazardHeader);
            headerRow.appendChild(questionHeader);
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            questions.forEach((item, index) => {
                const row = document.createElement('tr');
                
                const hazardCell = document.createElement('td');
                hazardCell.textContent = formatValue(item.climateHazards || 'N/A');
                hazardCell.style.padding = '8px';
                hazardCell.style.border = '1px solid #ddd';
                
                const questionCell = document.createElement('td');
                questionCell.textContent = item.Question || 'N/A';
                questionCell.style.padding = '8px';
                questionCell.style.border = '1px solid #ddd';
                
                row.appendChild(hazardCell);
                row.appendChild(questionCell);
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
        }

        function displayFGDQuestions(questions, container) {
            container.innerHTML = '<h4>Focus Group Discussion Questions:</h4>';
            
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '10px';
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const hazardHeader = document.createElement('th');
            hazardHeader.textContent = 'Climate Hazard';
            hazardHeader.style.padding = '8px';
            hazardHeader.style.backgroundColor = '#f2f2f2';
            hazardHeader.style.border = '1px solid #ddd';
            hazardHeader.style.textAlign = 'left';
            
            const questionHeader = document.createElement('th');
            questionHeader.textContent = 'Question';
            questionHeader.style.padding = '8px';
            questionHeader.style.backgroundColor = '#f2f2f2';
            questionHeader.style.border = '1px solid #ddd';
            hazardHeader.style.textAlign = 'left';
            
            const probesHeader = document.createElement('th');
            probesHeader.textContent = 'Potential Probes/Follow-ups';
            probesHeader.style.padding = '8px';
            probesHeader.style.backgroundColor = '#f2f2f2';
            probesHeader.style.border = '1px solid #ddd';
            probesHeader.style.textAlign = 'left';
            
            headerRow.appendChild(hazardHeader);
            headerRow.appendChild(questionHeader);
            headerRow.appendChild(probesHeader);
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            questions.forEach((item, index) => {
                const row = document.createElement('tr');
                
                const hazardCell = document.createElement('td');
                hazardCell.textContent = formatValue(item.climateHazards || 'N/A');
                hazardCell.style.padding = '8px';
                hazardCell.style.border = '1px solid #ddd';
                
                const questionCell = document.createElement('td');
                questionCell.textContent = item.Question || 'N/A';
                questionCell.style.padding = '8px';
                questionCell.style.border = '1px solid #ddd';
                
                const probesCell = document.createElement('td');
                probesCell.textContent = item.potentialProbes || 'N/A';
                probesCell.style.padding = '8px';
                probesCell.style.border = '1px solid #ddd';
                
                row.appendChild(hazardCell);
                row.appendChild(questionCell);
                row.appendChild(probesCell);
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
        }

   




function displayHFVAQuestions(questions, container) {
    container.innerHTML = '<h4>Health Facilities Vulnerability Assessment Checklist:</h4>';

    // Sort the questions array
    questions.sort((a, b) => {
        // First, sort by climateHazards
        const hazardA = (a.climateHazards || '').toLowerCase();
        const hazardB = (b.climateHazards || '').toLowerCase();
        if (hazardA < hazardB) return -1;
        if (hazardA > hazardB) return 1;

        // If climateHazards are equal, sort by Exposures
        const exposuresA = (a.Exposures || a.exposures || '').toLowerCase();
        const exposuresB = (b.Exposures || b.exposures || '').toLowerCase();
        if (exposuresA < exposuresB) return -1;
        if (exposuresA > exposuresB) return 1;

        // If Exposures are equal, sort by Category
        const categoryA = (a.category || '').toLowerCase();
        const categoryB = (b.category || '').toLowerCase();
        if (categoryA < categoryB) return -1;
        if (categoryA > categoryB) return 1;

        return 0; // If all are equal, maintain original order
    });
    
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '10px';
    
    // Create table header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    const hazardHeader = document.createElement('th');
    hazardHeader.textContent = 'Climate Hazard';
    hazardHeader.style.padding = '8px';
    hazardHeader.style.backgroundColor = '#f2f2f2';
    hazardHeader.style.border = '1px solid #ddd';
    hazardHeader.style.textAlign = 'left';
    
    const exposuresHeader = document.createElement('th');
    exposuresHeader.textContent = 'Exposures';
    exposuresHeader.style.padding = '8px';
    exposuresHeader.style.backgroundColor = '#f2f2f2';
    exposuresHeader.style.border = '1px solid #ddd';
    exposuresHeader.style.textAlign = 'left';

    const categoryHeader = document.createElement('th');
    categoryHeader.textContent = 'Category';
    categoryHeader.style.padding = '8px';
    categoryHeader.style.backgroundColor = '#f2f2f2';
    categoryHeader.style.border = '1px solid #ddd';
    categoryHeader.style.textAlign = 'left';

    const checklistHeader = document.createElement('th');
    checklistHeader.textContent = 'Checklist Item';
    checklistHeader.style.padding = '8px';
    checklistHeader.style.backgroundColor = '#f2f2f2';
    checklistHeader.style.border = '1px solid #ddd';
    checklistHeader.style.textAlign = 'left';
    
    headerRow.appendChild(hazardHeader);
    headerRow.appendChild(exposuresHeader);
    headerRow.appendChild(categoryHeader);
    headerRow.appendChild(checklistHeader);
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create table body
    const tbody = document.createElement('tbody');
    
    questions.forEach((item, index) => {
        const row = document.createElement('tr');
        
        const hazardCell = document.createElement('td');
        hazardCell.textContent = formatValue(item.climateHazards || 'N/A');
        hazardCell.style.padding = '8px';
        hazardCell.style.border = '1px solid #ddd';

        const exposuresCell = document.createElement('td');
        // Check for both possible exposure field names
        exposuresCell.textContent = item.Exposures || item.exposures || 'N/A';
        exposuresCell.style.padding = '8px';
        exposuresCell.style.border = '1px solid #ddd';

        const categoryCell = document.createElement('td');
        categoryCell.textContent = item.category || 'N/A';
        categoryCell.style.padding = '8px';
        categoryCell.style.border = '1px solid #ddd';
        
        const checklistCell = document.createElement('td');
        // Check for both possible checklist item field names
        checklistCell.textContent = item.questions || item.question || 'N/A';
        checklistCell.style.padding = '8px';
        checklistCell.style.border = '1px solid #ddd';
        
        row.appendChild(hazardCell);
        row.appendChild(exposuresCell);
        row.appendChild(categoryCell);
        row.appendChild(checklistCell);
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    container.appendChild(table);
}


        function displaySurveyQuestions(questions, container) {
            container.innerHTML = '<h4>Survey Questions:</h4>';
            
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '10px';
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const hazardHeader = document.createElement('th');
            hazardHeader.textContent = 'Climate Hazard';
            hazardHeader.style.padding = '8px';
            hazardHeader.style.backgroundColor = '#f2f2f2';
            hazardHeader.style.border = '1px solid #ddd';
            hazardHeader.style.textAlign = 'left';
            
            const questionHeader = document.createElement('th');
            questionHeader.textContent = 'Question';
            questionHeader.style.padding = '8px';
            questionHeader.style.backgroundColor = '#f2f2f2';
            questionHeader.style.border = '1px solid #ddd';
            questionHeader.style.textAlign = 'left';
            
            const answerHeader = document.createElement('th');
            answerHeader.textContent = 'Answer Type';
            answerHeader.style.padding = '8px';
            answerHeader.style.backgroundColor = '#f2f2f2';
            answerHeader.style.border = '1px solid #ddd';
            answerHeader.style.textAlign = 'left';
            
            const diseaseHeader = document.createElement('th');
            diseaseHeader.textContent = 'Disease Category';
            diseaseHeader.style.padding = '8px';
            diseaseHeader.style.backgroundColor = '#f2f2f2';
            diseaseHeader.style.border = '1px solid #ddd';
            diseaseHeader.style.textAlign = 'left';
            
            headerRow.appendChild(hazardHeader);
            headerRow.appendChild(questionHeader);
            headerRow.appendChild(answerHeader);
            headerRow.appendChild(diseaseHeader);
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            questions.forEach((item, index) => {
                const row = document.createElement('tr');
                
                const hazardCell = document.createElement('td');
                hazardCell.textContent = formatValue(item.climateHazards || 'N/A');
                hazardCell.style.padding = '8px';
                hazardCell.style.border = '1px solid #ddd';
                
                const questionCell = document.createElement('td');
                questionCell.textContent = item.Question || 'N/A';
                questionCell.style.padding = '8px';
                questionCell.style.border = '1px solid #ddd';
                
                const answerCell = document.createElement('td');
                answerCell.textContent = item.Answer || 'N/A';
                answerCell.style.padding = '8px';
                answerCell.style.border = '1px solid #ddd';
                
                const diseaseCell = document.createElement('td');
                diseaseCell.textContent = formatValue(item.diseaseCategory || 'N/A');
                diseaseCell.style.padding = '8px';
                diseaseCell.style.border = '1px solid #ddd';
                
                row.appendChild(hazardCell);
                row.appendChild(questionCell);
                row.appendChild(answerCell);
                row.appendChild(diseaseCell);
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
        }

    






function createEditableQuestions(questions, container, section) {
    container.innerHTML = '<h4>Edit Questions:</h4>';

    questions.forEach((item, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'editable-question';
        questionDiv.dataset.id = item.id;
        questionDiv.dataset.index = index;

        // Display the question text
        const questionTextSpan = document.createElement('span');
        questionTextSpan.textContent = item.Question || item.typeOfData || item.diseaseCategory || item.questions || 'Question';
        questionTextSpan.style.cursor = 'pointer'; // Indicate it's clickable
        questionDiv.appendChild(questionTextSpan);

        // Attach click event listener to make the question editable
        questionTextSpan.addEventListener('click', function () {
            // Create input field for editing
            const inputField = document.createElement('textarea');
            inputField.value = item.Question || item.typeOfData || item.diseaseCategory || item.questions || '';
            inputField.style.width = '100%';
            inputField.style.minHeight = '60px';
            inputField.style.marginBottom = '10px';
            inputField.style.padding = '8px';
            inputField.style.border = '1px solid #ccc';
            inputField.style.borderRadius = '4px';
            inputField.style.resize = 'vertical';

            // Create save and cancel buttons
            const saveBtn = document.createElement('button');
            saveBtn.textContent = '✓'; // Checkmark
            saveBtn.className = 'save-btn';
            saveBtn.style.backgroundColor = '#4CAF50';
            saveBtn.style.color = 'white';
            saveBtn.style.border = 'none';
            saveBtn.style.padding = '5px 10px';
            saveBtn.style.borderRadius = '4px';
            saveBtn.style.cursor = 'pointer';

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '✕'; // X mark
            cancelBtn.className = 'cancel-btn';
            cancelBtn.style.backgroundColor = '#f44336';
            cancelBtn.style.color = 'white';
            cancelBtn.style.border = 'none';
            cancelBtn.style.padding = '5px 10px';
            cancelBtn.style.borderRadius = '4px';
            cancelBtn.style.cursor = 'pointer';

            // Replace question text with input and buttons
            questionDiv.innerHTML = '';
            questionDiv.appendChild(inputField);
            questionDiv.appendChild(saveBtn);
            questionDiv.appendChild(cancelBtn);

            // Save button functionality
            saveBtn.onclick = function () {
                const newQuestionText = inputField.value.trim();
                if (!newQuestionText) {
                    alert('Question text cannot be empty.');
                    return;
                }

                // Update the question in the local array
                item.Question = newQuestionText;

                // Update the upper table immediately
                updateUpperTable(section);

                // Restore the display
                questionTextSpan.textContent = newQuestionText;
                questionDiv.innerHTML = '';
                questionDiv.appendChild(questionTextSpan);

                alert('Question updated.');
            };

            // Cancel button functionality
            cancelBtn.onclick = function () {
                questionDiv.innerHTML = '';
                questionDiv.appendChild(questionTextSpan);
            };
        });

        container.appendChild(questionDiv);
    });
}

// Function to update the upper table with the latest questions
function updateUpperTable(section) {
    const container = document.getElementById('questionsContainer');
    const questions = currentSectionQuestions[section];
    displayAllQuestions(questions, section);
}

// Function to save all changes and persist them locally linked to submissionId
async function saveAllChanges() {
    try {
        const editableQuestions = document.querySelectorAll('.editable-question');

        for (const questionDiv of editableQuestions) {
            const id = questionDiv.dataset.id;
            const index = questionDiv.dataset.index;

            // Skip new questions
            if (index === 'new' || !id) continue;

            // Find the input or textarea element to get the updated value
            const inputElement = questionDiv.querySelector('textarea') || questionDiv.querySelector('input');

            if (!inputElement) {
                console.warn(`No input element found for question ID: ${id}`);
                continue; // Skip this question if there's no input element
            }

            const updatedValue = inputElement.value.trim();

            // Update local data
            const sectionQuestions = currentSectionQuestions[currentSection];
            if (sectionQuestions && sectionQuestions[index]) {
                sectionQuestions[index].Question = updatedValue;
            }
        }

        // Persist the updated data in localStorage linked to submissionId
        if (currentSubmissionId) {
            localStorage.setItem(`questions_${currentSubmissionId}`, JSON.stringify(currentSectionQuestions));
        }

        alert('All changes saved.');
        closeModal('questionsModal'); // Close the modal popup
    } catch (error) {
        console.error('Error saving all changes:', error);
        alert('Error saving changes: ' + error.message);
    }
}

// Function to add a new question
function addNewQuestion() {
    const sectionQuestions = currentSectionQuestions[currentSection] || [];
    const newQuestion = {
        id: `new_${Date.now()}`, // Unique ID for the new question
        Question: 'New Question',
        climateHazards: 'All',
        Answer: '',
        diseaseCategory: 'All'
    };

    sectionQuestions.push(newQuestion);
    currentSectionQuestions[currentSection] = sectionQuestions;

    // Update the UI
    displayAllQuestions(sectionQuestions, currentSection);
    createEditableQuestions(sectionQuestions, document.getElementById('editQuestionsContainer'), currentSection);

    alert('New question added.');
}

// Function to load saved data from localStorage based on submissionId
function loadSavedData(submissionId) {
    const savedData = localStorage.getItem(`questions_${submissionId}`);
    if (savedData) {
        currentSectionQuestions = JSON.parse(savedData);
        console.log('Loaded saved data:', currentSectionQuestions);
    } else {
        console.log('No saved data found for submissionId:', submissionId);
        currentSectionQuestions = {}; // Reset to avoid overlap
    }
}

// Update the initialization to load saved data on page load
document.addEventListener('DOMContentLoaded', function () {
    // Check database structure (for debugging)
    checkDatabaseStructure();
    
    // Get submission ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const submissionId = urlParams.get('submissionId');
    
    console.log("URL Parameters:", window.location.search);
    console.log("Submission ID from URL:", submissionId);
    
    if (submissionId) {
        currentSubmissionId = submissionId;
        console.log("Loading assessment details for ID:", submissionId);

        // Load saved data for the current submissionId
        loadSavedData(submissionId);

        loadAssessmentDetails(submissionId);
    } else {
        document.getElementById('assessmentDetails').innerHTML = 
            '<p>No submission ID found. Please go back to the input form and submit your selections.</p>';
    }
    
    // Add event listener for save all button
    document.getElementById('saveAllQuestionsBtn').addEventListener('click', saveAllChanges);

    // Add event listener to the button outside the function
    document.getElementById('export-excel-btn').addEventListener('click', exportAssessment); 
});

function exportAssessment() {
    if (!currentSubmissionData) {
        alert('No assessment data to export');
        return;
    }

    const workbook = new ExcelJS.Workbook();
    workbook.creator = 'Climate Health Assessment';
    workbook.created = new Date();

    // Add a sheet for each section
    Object.keys(sectionCollections).forEach(section => {
        let sectionTitle = getSectionTitle(section);

        // Truncate worksheet name to 31 characters if necessary
        if (sectionTitle.length > 31) {
            sectionTitle = sectionTitle.substring(0, 31);
        }

        // Use the updated questions from currentSectionQuestions
        const filteredQuestions = currentSectionQuestions[section] || [];

        if (filteredQuestions.length > 0) {
            const worksheet = workbook.addWorksheet(sectionTitle);

            let headers = [];
            switch (section) {
                case 'survey':
                    headers = ['Question', 'Answer Type'];
                    break;
                case 'kii':
                    headers = ['Question'];
                    break;
                case 'fgd':
                    headers = ['Question', 'Potential Probes/Follow-ups'];
                    break;
                case 'hfva':
                    headers = ['Climate Hazard', 'Exposures', 'Category', 'Checklist Item', 'High', 'Medium', 'Low'];
                    break;
                case 'climateTrends':
                    headers = ['Climate Hazard', 'Type of Data to be Collected', 'Description'];
                    break;
                case 'diseaseHazards':
                    headers = ['Climate Hazard', 'Disease Category', 'Indicators to Follow'];
                    break;
                default:
                    headers = ['Question'];
            }

            // Add styled header row
            const headerRow = worksheet.addRow(headers);
            headerRow.eachCell((cell, number) => {
                cell.font = { bold: true, size: 12 };
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFD3D3D3' } // Light gray
                };
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
                cell.alignment = { wrapText: true };
            });
            
            // Set fixed column width to 30 (adjust as needed)
            worksheet.columns.forEach(column => {
                column.width = 30;
                column.alignment = { wrapText: true, vertical: 'top' };
            });

            // Add rows for filtered questions
            filteredQuestions.forEach(question => {
                const row = [];

                if (section === 'hfva') {
                    row.push(question.climateHazards || '');
                    row.push(question.Exposures || question.exposures || '');
                    row.push(question.category || '');
                    row.push(question.questions || question.question || '');
                    row.push('\u2610'); // High
                    row.push('\u2610'); // Medium
                    row.push('\u2610'); // Low
                } else if (section === 'diseaseHazards') {
                    row.push(question.climateHazards || '');
                    row.push(question.diseaseCategory || '');
                    row.push(question.indicatorsToFollow || '');
                } else if (section === 'climateTrends') {
                    row.push(question.climateHazards || '');
                    row.push(question.typeOfData || '');
                    row.push(question.Description || '');
                } else if (section === 'fgd') {
                    row.push(question.Question || '');
                    row.push(question.potentialProbes || '');
                } else if (section === 'kii') {
                    row.push(question.Question || '');
                } else if (section === 'survey') {
                    row.push(question.Question || '');
                    row.push(question.Answer || '');
                } else {
                    row.push('');
                }
                worksheet.addRow(row);
            });
        }
    });

    // Export workbook as Excel file
    workbook.xlsx.writeBuffer().then(buffer => {
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'climate_health_assessment.xlsx';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Display thank-you message
        alert("Thank you for using the Canadian Red Cross new Anticipatory Actions for Climate Health Vulnerability toolkit developed by the Global Health in Emergency Research Team. Best regards, Ahmad Wehbi.");
    });
}

// Debugging: Check sessionStorage for diseaseHazards
console.log('Session storage for diseaseHazards:', sessionStorage.getItem('diseaseHazards_filteredQuestions'));


        // Helper function to format values
        function formatValue(value) {
            if (!value) return '';

            // Convert snake_case to Title Case
            if (typeof value === 'string') {
                return value.split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            } else if (Array.isArray(value)) {
                return value.map(item => formatValue(item)).join(', ');
            }

            return value.toString();
        }

        // Function to check database structure
        async function checkDatabaseStructure() {
            try {
                console.log("Checking database structure...");
                
                // Check each collection
                for (const [section, collectionName] of Object.entries(sectionCollections)) {
                    console.log(`Checking ${section} (${collectionName})...`);
                    
                    try {
                        const snapshot = await db.collection(collectionName).limit(1).get();
                        console.log(`${collectionName} exists:`, !snapshot.empty);
                        
                        if (!snapshot.empty) {
                            snapshot.forEach(doc => {
                                console.log(`Sample ${collectionName} document:`);
                                inspectDocument(doc);
                            });
                        }
                    } catch (error) {
                        console.error(`Error checking ${collectionName}: ${error}`);
                    }
                }
            } catch (error) {
                console.error("Error checking database structure:", error);
            }
        }

        // Function to handle the Generate Solutions button
        function generateSolutions() {
            alert("This section is still under construction and research!");
        }
    </script>
<div id="debuggingTools" style="margin: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;">
    <h3>Debugging Tools</h3>
    <button onclick="testCollections()">Test All Collections</button>
    <input type="text" id="submissionIdInput" placeholder="Enter submission ID manually" style="margin-top: 10px; padding: 5px; width: 300px;">
    <div id="debugOutput" style="margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; max-height: 300px; overflow-y: auto;"></div>
</div>

<script>
    // Add event listener to toggle debugging tools on right-click
    document.addEventListener('contextmenu', function (event) {
        event.preventDefault();
        const debuggingTools = document.getElementById('debuggingTools');
        debuggingTools.style.display = debuggingTools.style.display === 'none' ? 'block' : 'none';
    });
</script>

<script>
// Add this function to your JavaScript
async function testCollections() {
    const debugOutput = document.getElementById('debugOutput');
    debugOutput.innerHTML = "<h4>Testing Collections</h4>";
    
    if (!currentSubmissionData) {
        debugOutput.innerHTML += "<p>No submission data loaded. Cannot test collections.</p>";
        return;
    }
    
    const climateHazards = currentSubmissionData.climateHazards || [];
    const diseases = currentSubmissionData.diseases || [];
    
    debugOutput.innerHTML += `<p>Testing with climate hazards: ${climateHazards.join(', ')}</p>`;
    debugOutput.innerHTML += `<p>Testing with diseases: ${diseases.join(', ')}</p>`;
    
    for (const [section, collectionName] of Object.entries(sectionCollections)) {
        debugOutput.innerHTML += `<h5>Testing ${section} (${collectionName})</h5>`;
        
        try {
            // Check if collection exists
            const collectionTest = await db.collection(collectionName).limit(1).get();
            if (collectionTest.empty) {
                debugOutput.innerHTML += `<p>Collection ${collectionName} exists but is empty.</p>`;
                continue;
            } else {
                debugOutput.innerHTML += `<p>Collection ${collectionName} exists and has documents.</p>`;
            }
            
            // Test different query strategies
            let results = [];
            
            // Strategy 1: Array contains any (if climateHazards is an array field)
            try {
                const query1 = await db.collection(collectionName)
                    .where('climateHazards', 'array-contains-any', climateHazards)
                    .limit(5)
                    .get();
                
                debugOutput.innerHTML += `<p>Query 1 (array-contains-any): ${query1.size} results</p>`;
                if (!query1.empty) {
                    results = [...query1.docs];
                }
            } catch (error) {
                debugOutput.innerHTML += `<p>Query 1 error: ${error.message}</p>`;
            }
            
            // Strategy 2: Equality check (if climateHazards is a string field)
            if (results.length === 0) {
                try {
                    const query2 = await db.collection(collectionName)
                        .where('Climate Hazards', '==', climateHazards[0])
                        .limit(5)
                        .get();
                    
                    debugOutput.innerHTML += `<p>Query 2 (equality): ${query2.size} results</p>`;
                    if (!query2.empty) {
                        results = [...query2.docs];
                    }
                } catch (error) {
                    debugOutput.innerHTML += `<p>Query 2 error: ${error.message}</p>`;
                }
            }
            
            // Strategy 3: Get all documents (fallback)
            if (results.length === 0) {
                try {
                    const query3 = await db.collection(collectionName)
                        .limit(5)
                        .get();
                    
                    debugOutput.innerHTML += `<p>Query 3 (all docs): ${query3.size} results</p>`;
                    if (!query3.empty) {
                        results = [...query3.docs];
                    }
                } catch (error) {
                    debugOutput.innerHTML += `<p>Query 3 error: ${error.message}</p>`;
                }
            }
            
            // Show sample document
            if (results.length > 0) {
                const sampleDoc = results[0].data();
                debugOutput.innerHTML += `<p>Sample document: ${JSON.stringify(sampleDoc)}</p>`;
                
                // Check field names
                const fields = Object.keys(sampleDoc);
                debugOutput.innerHTML += `<p>Fields: ${fields.join(', ')}</p>`;
                
                // Check if it has climateHazards field
                if (sampleDoc.climateHazards) {
                    debugOutput.innerHTML += `<p>climateHazards type: ${Array.isArray(sampleDoc.climateHazards) ? 'array' : typeof sampleDoc.climateHazards}</p>`;
                    debugOutput.innerHTML += `<p>climateHazards value: ${JSON.stringify(sampleDoc.climateHazards)}</p>`;
                } else {
                    debugOutput.innerHTML += `<p>No climateHazards field found!</p>`;
                }
            } else {
                debugOutput.innerHTML += `<p>No documents found in ${collectionName}</p>`;
            }
            
        } catch (error) {
            debugOutput.innerHTML += `<p>Error testing ${collectionName}: ${error.message}</p>`;
        }
        
        debugOutput.innerHTML += "<hr>";
    }
}

</script>

</body>
</html>
``` 

